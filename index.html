<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Test: Food Search & Pie-Chart</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.6.0/dist/ml5.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font:1em/1.4 'Segoe UI',sans-serif;background:#f5fcf7;color:#333;}
    .container{max-width:800px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.05);}
    h2{text-align:center;color:#2a7955;margin-bottom:16px;}
    .flex{display:flex;gap:24px;flex-wrap:wrap;}
    .left,.right{flex:1;min-width:300px;position:relative;}
    input,button{width:100%;padding:10px;margin-top:8px;border:1px solid #cdefe1;border-radius:8px;font-size:1em;}
    button{background:linear-gradient(90deg,#2a7955,#5fb58c);color:#fff;border:none;cursor:pointer;}
    button:hover{background:linear-gradient(90deg,#236643,#4fa27f);}
    #preview{display:none;margin:12px auto;max-height:120px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
    canvas{width:100%!important;height:160px!important;margin-top:12px;}
    #foodList{margin-top:8px;max-height:220px;overflow-y:auto;border:1px solid #cdefe1;border-radius:8px;background:#f0fff8;}
    .food-item{padding:8px 10px;border-bottom:1px solid #e0e0e0;cursor:pointer;}
    .food-item:last-child{border-bottom:none;}
    .food-item:hover{background:rgba(42,121,85,0.1);}
    #foodDetail{display:none;margin-top:8px;padding:12px;background:#fff;border:1px solid #cdefe1;border-radius:8px;box-shadow:0 2px 12px rgba(0,0,0,0.1);}
    #foodDetail button{position:absolute;top:8px;right:8px;background:none;border:none;font-size:1.2em;cursor:pointer;color:#666;}
  </style>
</head>
<body>
  <div class="container">
    <h2>Analisis Makanan Anda!</h2>
    <div class="flex">
      <!-- PHOTO + PIE CHART -->
      <div class="left">
        <input id="imageUrl" placeholder="URL foto (opsional)" type="url">
        <input id="foodPhoto" type="file" accept="image/*">
        <button id="analyze">Analisis Foto</button>
        <img id="preview" alt="Preview Gambar">
        <canvas id="pieChart"></canvas>
      </div>

      <!-- SEARCHABLE LIST + DETAILS -->
      <div class="right">
        <input id="foodSearch" placeholder="Cari makanan...">
        <div id="foodList"></div>
        <div id="foodDetail">
          <button id="closeDetail">&times;</button>
          <div id="detailContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // food data
    const foods = [
      {key:"apple",name:"Apel",protein:0.3,carbs:14,fats:0.2,energy:52},
      {key:"banana",name:"Pisang",protein:1.3,carbs:23,fats:0.3,energy:96},
      {key:"nasigoreng",name:"Nasi Goreng",protein:7,carbs:50,fats:15,energy:350},
      {key:"sotoayam",name:"Soto Ayam",protein:8,carbs:10,fats:5,energy:120},
      {key:"rendang",name:"Rendang",protein:14,carbs:2,fats:30,energy:320},
      {key:"bakso",name:"Bakso",protein:6,carbs:5,fats:7,energy:120},
      {key:"miegoreng",name:"Mie Goreng",protein:8,carbs:60,fats:20,energy:400},
      {key:"pepek",name:"Pempek",protein:12,carbs:30,fats:5,energy:220},
      {key:"gado",name:"Gado Gado",protein:10,carbs:20,fats:10,energy:220},
      {key:"sate",name:"Sate Ayam",protein:9,carbs:2,fats:10,energy:150},
      {key:"ayamgoreng",name:"Ayam Goreng",protein:25,carbs:0,fats:20,energy:300},
      {key:"nasiuduk",name:"Nasi Uduk",protein:6,carbs:50,fats:15,energy:350},
      {key:"buburayam",name:"Bubur Ayam",protein:5,carbs:30,fats:3,energy:180},
      {key:"ketoprak",name:"Ketoprak",protein:8,carbs:30,fats:10,energy:260},
      {key:"lontongsayur",name:"Lontong Sayur",protein:4,carbs:40,fats:8,energy:260},
      {key:"sotobetawi",name:"Soto Betawi",protein:9,carbs:10,fats:20,energy:240},
      {key:"pempekju",name:"Pempek Lenggang",protein:14,carbs:28,fats:6,energy:260},
      {key:"martabak",name:"Martabak Telor",protein:14,carbs:10,fats:20,energy:300},
      {key:"martabaks",name:"Martabak Manis",protein:6,carbs:45,fats:15,energy:330},
      {key:"sotobetawi",name:"Soto Betawi",protein:9,carbs:10,fats:20,energy:240}
    ];
    const db = Object.fromEntries(foods.map(f=>[f.key,f]));

    // refs
    const foodList    = document.getElementById("foodList");
    const foodSearch  = document.getElementById("foodSearch");
    const detailBox   = document.getElementById("foodDetail");
    const detailCont  = document.getElementById("detailContent");
    document.getElementById("closeDetail").onclick = () => detailBox.style.display = "none";

    // build searchable list
    function buildList() {
      foodList.innerHTML = "";
      foods.forEach(f => {
        const d = document.createElement("div");
        d.className = "food-item";
        d.textContent = f.name;
        d.onclick = () => showDetail(f);
        foodList.append(d);
      });
    }
    buildList();
    foodSearch.oninput = () => {
      const q = foodSearch.value.toLowerCase();
      document.querySelectorAll(".food-item").forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
      });
      detailBox.style.display = "none";
    };

    function showDetail(f) {
      detailCont.innerHTML = `
        <h4>${f.name}</h4>
        <p>Protein: ${f.protein} g</p>
        <p>Karbo: ${f.carbs} g</p>
        <p>Lemak: ${f.fats} g</p>
        <p>Energi: ${f.energy} kcal</p>
      `;
      detailBox.style.display = "block";
    }

    // photo analyzer + pie chart
    const preview   = document.getElementById("preview");
    const analyzeBtn= document.getElementById("analyze");
    const pieCan    = document.getElementById("pieChart");

    analyzeBtn.onclick = async () => {
      let src = document.getElementById("imageUrl").value.trim();
      const file = document.getElementById("foodPhoto").files[0];
      if (!src && file) src = URL.createObjectURL(file);
      if (!src) return alert("Masukkan URL atau file.");

      preview.src = src;
      preview.style.display = "block";

      // classify
      const clf = await ml5.imageClassifier("MobileNet");
      const [res] = await clf.classify(preview);
      const key = res.label.split(",")[0].toLowerCase();
      const info = db[key] || {name:key,protein:0,carbs:0,fats:0,energy:0};

      // calc %
      const total = info.protein + info.carbs + info.fats || 1;
      const data  = [
        Math.round(info.protein/total*100),
        Math.round(info.carbs/total*100),
        Math.round(info.fats/total*100)
      ];

      // draw pie
      if (pieCan._chart) pieCan._chart.destroy();
      pieCan._chart = new Chart(pieCan.getContext("2d"), {
        type:"pie",
        data:{ labels:["Protein","Karbo","Lemak"], datasets:[{ data, backgroundColor:["#2a7955","#5fb58c","#e57373"] }]},
        options:{ responsive:true,maintainAspectRatio:false,plugins:{ legend:{ position:"bottom" }}}
      });
    };
  });
  </script>
</body>
</html>
