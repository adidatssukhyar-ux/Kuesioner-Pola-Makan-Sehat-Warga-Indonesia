<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pola Makan Sehat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- ML5.js, Chart.js & Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.6.0/dist/ml5.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js" defer></script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5fcf7;
      color: #333;
      line-height: 1.4;
    }
    .container {
      max-width: 500px;
      margin: 40px auto;
      padding: 24px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      transition: max-width .3s;
    }
    .container.wide { max-width: 90%; }
    .logo {
      text-align: center;
      margin-bottom: 16px;
    }
    .logo img {
      width: 80px;
      border-radius: 8px;
    }
    h1, h2 {
      text-align: center;
      color: #2a7955;
      margin-bottom: 16px;
    }
    h1 { font-size: 1.8em; }
    h2 { font-size: 1.3em; }

    section { display: none; }
    section.active { display: block; }

    .question-text,
    label,
    .analysis-list h2 {
      display: block;
      margin-top: 16px;
      font-weight: 600;
      color: #2a7955;
    }
    textarea,
    input[type="url"],
    input[type="file"],
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #cdefe1;
      border-radius: 8px;
      font-size: 1em;
    }
    textarea { resize: vertical; }
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background: linear-gradient(90deg,#2a7955,#5fb58c);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
    }
    .btn:hover {
      background: linear-gradient(90deg,#236643,#4fa27f);
    }
    .project-credit {
      text-align: center;
      font-size: 0.85em;
      color: #666;
      margin-top: 24px;
    }

    /* AI overview box */
    #aiOverview {
      min-height: 80px;
      padding: 12px;
      border: 1px solid #cdefe1;
      border-radius: 8px;
      background: #f0fff8;
      font-size: 0.95em;
      line-height: 1.4;
    }

    /* Spinner overlay */
    .spinner-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      z-index: 1000;
    }
    .spinner-overlay.active {
      visibility: visible;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 6px solid #cdefe1;
      border-top-color: #2a7955;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* STEP 3: Photo & Food Search layout */
    .analysis-flex {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .analysis-photo,
    .analysis-list {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    #preview {
      display: none;
      margin: 12px auto;
      max-height: 120px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .chart-container {
      position: relative;
      height: 160px;
      margin-top: 12px;
    }
    .chart-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important;
      height: 100% !important;
    }
    .food-list {
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #cdefe1;
      border-radius: 8px;
      background: #f0fff8;
    }
    .food-item {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
      cursor: pointer;
      font-size: 0.95em;
    }
    .food-item:last-child { border-bottom: none; }
    .food-item:hover { background: rgba(42,121,85,0.1); }

    #foodDetailPanel {
      display: none;
      margin-top: 8px;
      padding: 12px;
      background: #fff;
      border: 1px solid #cdefe1;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      position: relative;
    }
    #foodDetailPanel.show { display: block; }
    #foodDetailPanel .close-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: none; border: none;
      font-size: 1.2em; cursor: pointer; color: #666;
    }
  </style>
</head>

<body>
  <div class="container" id="mainContainer">
    <div class="logo">
      <img src="https://yt3.ggpht.com/a/AATXAJwRp9NDxa9WX7nh8uuO9TUCUCMqCRE5yJp4CQ=s900-c-k-c0xffffffff-no-rj-mo"
           alt="Logo Sekolah Al Ikhlas">
    </div>
    <h1>Pola Makan Sehat</h1>

    <!-- STEP 1: Survey -->
    <section id="step1" class="active">
      <div class="question-text" id="question"></div>
      <textarea id="answer" placeholder="Tuliskan jawaban..."></textarea>
      <button id="step1Next" class="btn">Next</button>
      <div class="project-credit">Karya Kelompok 1 — Proyek 1</div>
    </section>

    <!-- STEP 2: AI Overview -->
    <section id="step2">
      <h2>Overview AI</h2>
      <div id="aiOverview"></div>
      <button id="step2Next" class="btn">Lanjut ke Analisis</button>
    </section>

    <!-- STEP 3: Photo Analysis & Food Search -->
    <section id="step3">
      <h2>Analisis Makanan Anda!</h2>
      <div class="analysis-flex">
        <!-- Photo Analysis -->
        <div class="analysis-photo">
          <label for="imageUrl">URL Foto (opsional)</label>
          <input type="url" id="imageUrl" placeholder="https://...">
          <label for="foodPhoto">Atau Pilih File</label>
          <input type="file" id="foodPhoto" accept="image/*">
          <button id="photoSubmit" class="btn">Analisis Foto</button>
          <img id="preview" alt="Preview Gambar" />
          <div id="photoAnalysis"></div>

          <div class="chart-container">
            <canvas id="pieCan"></canvas>
          </div>
          <div class="chart-container">
            <canvas id="barCan"></canvas>
          </div>
        </div>

        <!-- Food Search & Detail -->
        <div class="analysis-list">
          <h2>Pilih Makanan Lain</h2>
          <input type="text" id="foodSearch" placeholder="Cari makanan...">
          <div id="foodList" class="food-list"></div>
          <div id="foodDetailPanel">
            <button class="close-btn">&times;</button>
            <div id="foodDetails"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="spinner" class="spinner-overlay">
    <div class="spinner"></div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Questions & state
    const questions = [
      "1. Menurut kamu junk food sehat atau tidak?",
      "2. Seberapa sering konsumsi junk food?",
      "3. Berapa kali makan sehari?",
      "4. Sering minum soda/berwarna?",
      "5. Sering makan sayur?",
      "6. Sebut satu makanan bergizi & satu tidak.",
      "7. Seberapa penting nutrisi seimbang?",
      "8. Buah/sayur favorit?",
      "9. Tantangan makan sehat?",
      "10. Rencana pola makan lebih baik?"
    ];
    let idx = 0, answers = [];

    // Macro DB (sample items)
    const macroDBList = [
      {key:"apple",name:"Apel",protein:0.3,carbs:14,fats:0.2,energy:52},
      {key:"banana",name:"Pisang",protein:1.3,carbs:23,fats:0.3,energy:96},
      {key:"nasigoreng",name:"Nasi Goreng",protein:7,carbs:50,fats:15,energy:350},
      {key:"sotoayam",name:"Soto Ayam",protein:8,carbs:10,fats:5,energy:120},
      {key:"rendang",name:"Rendang",protein:14,carbs:2,fats:30,energy:320},
      {key:"bakso",name:"Bakso",protein:6,carbs:5,fats:7,energy:120},
      {key:"miegoreng",name:"Mie Goreng",protein:8,carbs:60,fats:20,energy:400},
      {key:"gadogado",name:"Gado Gado",protein:10,carbs:20,fats:10,energy:220},
      {key:"sateayam",name:"Sate Ayam",protein:9,carbs:2,fats:10,energy:150},
      {key:"ayamgoreng",name:"Ayam Goreng",protein:25,carbs:0,fats:20,energy:300},
      {key:"pempek",name:"Pempek",protein:12,carbs:30,fats:5,energy:220},
      {key:"nasipadang",name:"Nasi Padang",protein:8,carbs:45,fats:15,energy:360},
      {key:"nasiuduk",name:"Nasi Uduk",protein:6,carbs:50,fats:15,energy:350},
      {key:"buburayam",name:"Bubur Ayam",protein:5,carbs:30,fats:3,energy:180},
      {key:"ketoprak",name:"Ketoprak",protein:8,carbs:30,fats:10,energy:260},
      {key:"lontongsayur",name:"Lontong Sayur",protein:4,carbs:40,fats:8,energy:260},
      {key:"sotobetawi",name:"Soto Betawi",protein:9,carbs:10,fats:20,energy:240},
      {key:"escampur",name:"Es Campur",protein:2,carbs:30,fats:5,energy:180},
      {key:"martabaktelor",name:"Martabak Telor",protein:14,carbs:10,fats:20,energy:300},
      {key:"martabakmanis",name:"Martabak Manis",protein:6,carbs:45,fats:15,energy:330}
    ];
    const macroDB = Object.fromEntries(macroDBList.map(o=>[o.key,o]));

    // DOM refs
    const step1      = document.getElementById("step1");
    const step2      = document.getElementById("step2");
    const step3      = document.getElementById("step3");
    const qEl        = document.getElementById("question");
    const aEl        = document.getElementById("answer");
    const btn1       = document.getElementById("step1Next");
    const btn2       = document.getElementById("step2Next");
    const aiDiv      = document.getElementById("aiOverview");
    const spinner    = document.getElementById("spinner");

    const imageUrl   = document.getElementById("imageUrl");
    const foodPhoto  = document.getElementById("foodPhoto");
    const photoBtn   = document.getElementById("photoSubmit");
    const preview    = document.getElementById("preview");
    const analysis   = document.getElementById("photoAnalysis");
    const pieCan     = document.getElementById("pieCan");
    const barCan     = document.getElementById("barCan");

    const foodSearch = document.getElementById("foodSearch");
    const foodList   = document.getElementById("foodList");
    const detailPan  = document.getElementById("foodDetailPanel");
    const closeBtn   = detailPan.querySelector(".close-btn");
    const foodDetails= document.getElementById("foodDetails");

    // Survey rendering
    function showQuestion(i) {
      qEl.textContent = questions[i];
      aEl.value = "";
      btn1.textContent = i < questions.length - 1 ? "Next" : "Submit";
    }
    showQuestion(idx);

    // Step1 → Step2
    btn1.addEventListener("click", async () => {
      const v = aEl.value.trim();
      if (!v) return alert("Isi jawaban dulu.");
      answers[idx] = v;
      if (idx < questions.length - 1) {
        idx++; showQuestion(idx);
      } else {
        confetti({ particleCount:100, spread:60, origin:{ y:0.4 } });
        step1.classList.replace("active","hidden");
        step2.classList.add("active");
        spinner.classList.add("active");
        aiDiv.textContent = "Memuat overview AI…";
        const prompt = answers.map((a,i)=>`${questions[i]}\nJawaban: ${a}`).join("\n\n");
        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDIVFI3M-283v1Ume5ivh3iHnByP_RAxh0`,
            {
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({ contents:[{ parts:[{ text:`Ringkas pola makan:\n\n${prompt}` }] }] })
            }
          );
          const json = await res.json();
          const text = json.candidates?.[0]?.content?.parts?.[0]?.text || "AI gagal.";
          aiDiv.innerHTML = text.replace(/\n/g,"<br>");
        } catch {
          aiDiv.innerHTML = "<span style='color:red'>Error AI.</span>";
        } finally {
          spinner.classList.remove("active");
        }
      }
    });

    // Step2 → Step3
    btn2.addEventListener("click", () => {
      step2.classList.replace("active","hidden");
      step3.classList.add("active");
      document.getElementById("mainContainer").classList.add("wide");
      buildFoodList();
    });

    // Food list & search
    function buildFoodList() {
      detailPan.classList.remove("show");
      foodList.innerHTML = "";
      foodSearch.value = "";
      macroDBList.forEach(item => {
        const d = document.createElement("div");
        d.className = "food-item";
        d.textContent = item.name;
        d.onclick = () => showDetail(item);
        foodList.append(d);
      });
    }

    foodSearch.addEventListener("input", () => {
      const q = foodSearch.value.toLowerCase();
      document.querySelectorAll('.food-item').forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
      });
      detailPan.classList.remove("show");
    });

    function showDetail(item) {
      foodDetails.innerHTML = `
        <h4>${item.name}</h4>
        <p>Protein: ${item.protein} g</p>
        <p>Karbo: ${item.carbs} g</p>
        <p>Lemak: ${item.fats} g</p>
        <p>Energi: ${item.energy} kcal</p>
      `;
      detailPan.classList.add("show");
    }
    closeBtn.onclick = () => detailPan.classList.remove("show");

    // Photo analysis & charts
    photoBtn.addEventListener("click", async () => {
      let src = imageUrl.value.trim();
      if (!src && foodPhoto.files[0]) src = URL.createObjectURL(foodPhoto.files[0]);
      if (!src) return alert("Masukkan URL atau pilih file.");
      preview.src = src; preview.classList.remove("hidden");
      analysis.textContent = "";
      spinner.classList.add("active");

      const classifier = await ml5.imageClassifier("MobileNet");
      const [res]      = await classifier.classify(preview);
      const key        = res.label.split(",")[0].toLowerCase();
      const info       = macroDB[key] || { name:key, protein:5, carbs:20, fats:5, energy:120 };

      // Pie
      const total = info.protein + info.carbs + info.fats;
      const pct   = [info.protein, info.carbs, info.fats].map(v=>Math.round(v/total*100));
      renderPie(pct, ["Protein","Karbo","Lemak"], pieCan);

      // Bar
      renderBar(
        [info.protein, info.carbs, info.fats, info.energy],
        ["Protein(g)","Karbo(g)","Lemak(g)","Energi(kcal)"],
        barCan
      );

      analysis.innerHTML = `<p>${info.name}: ${info.protein}g P, ${info.carbs}g C, ${info.fats}g L, ${info.energy} kcal</p>`;
      spinner.classList.remove("active");
    });

    function clearChart(c) { if (c._chart) c._chart.destroy(); }
    function renderPie(data, labels, c) {
      clearChart(c);
      c._chart = new Chart(c.getContext("2d"), {
        type: "pie",
        data: { labels, datasets: [{ data, backgroundColor:["#35a35c","#f5bc51","#e57373"] }] },
        options: {
          responsive: true,
          animation: { animateScale:true, duration:800, easing:"easeOutQuad" },
          plugins:{ legend:{ position:"bottom" } }
        }
      });
    }
    function renderBar(data, labels, c) {
      clearChart(c);
      c._chart = new Chart(c.getContext("2d"), {
        type: "bar",
        data: { labels, datasets: [{ label:"Jumlah", data, backgroundColor:["#35a35c","#f5bc51","#e57373","#5c97f5"] }] },
        options: {
          indexAxis:"y",
          responsive:true,
          animation:{ duration:1000, easing:"easeOutBounce" }
        }
      });
    }
  });
  </script>
</body>
</html>
