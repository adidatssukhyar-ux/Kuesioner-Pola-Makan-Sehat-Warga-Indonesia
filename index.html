<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <!-- Chart.js for pie chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Pola Makan Sehat Orang Indonesia</h1>

    <form id="wizardForm" autocomplete="off">
      <label for="email">Email kamu:</label>
      <input type="email" id="email" placeholder="nama@contoh.com" required />

      <div id="questionContainer"></div>

      <button type="button" id="nextBtn">Next</button>
      <button type="button" id="showAnswersBtn">ðŸ“‹ Lihat Semua Jawaban</button>
      <button type="button" id="clearLocalBtn">ðŸ—‘ Hapus Jawaban Lokal</button>
      <button type="submit" id="submitBtn" style="display:none;">Kirim</button>
    </form>

    <div id="thankYouMessage" style="display:none; margin-top:20px; text-align:center;">
      terimakasih telah menjawab survei ini
    </div>

    <div id="aiOverview" style="display:none; margin-top:20px;"></div>

    <!-- Photo survey section -->
    <div id="photoSection" style="display:none; margin-top:20px;">
      <h2>Upload Foto Makanan</h2>
      <input type="file" id="foodPhoto" accept="image/*" />
      <button type="button" id="photoSubmit">Analisis Foto</button>
      <div id="photoAnalysis" style="margin-top:16px;"></div>
      <canvas id="macroChart" style="max-width:100%; margin-top:20px;"></canvas>
    </div>

    <div id="answersContainer" style="display:none; margin-top:20px; overflow:auto;"></div>
  </div>

  <script type="module">
    // ===== Constants & State =====
    const API_KEY = "AIzaSyDIVFI3M-283v1Ume5ivh3iHnByP_RAxh0";
    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi makanan junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur sayuran?",
      "6. Sebutkan makanan yang bergizi dan tidak bergizi",
      "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
      "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
      "9. Apakah kamu hari ini sudah sarapan?",
      "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
    ];
    const S = {
      currentQuestion: 0,
      tempAnswers: [],
      allAnswers: JSON.parse(localStorage.getItem("responses") || "[]"),
    };

    // ===== DOM Refs =====
    const D = {
      emailInput:       document.getElementById("email"),
      questionContainer:document.getElementById("questionContainer"),
      nextBtn:          document.getElementById("nextBtn"),
      submitBtn:        document.getElementById("submitBtn"),
      form:             document.getElementById("wizardForm"),
      thankYouMessage:  document.getElementById("thankYouMessage"),
      aiOverview:       document.getElementById("aiOverview"),
      photoSection:     document.getElementById("photoSection"),
      foodPhoto:        document.getElementById("foodPhoto"),
      photoSubmit:      document.getElementById("photoSubmit"),
      photoAnalysis:    document.getElementById("photoAnalysis"),
      macroChart:       document.getElementById("macroChart"),
      showAnswersBtn:   document.getElementById("showAnswersBtn"),
      clearLocalBtn:    document.getElementById("clearLocalBtn"),
      answersContainer: document.getElementById("answersContainer"),
    };

    // ===== Helper: show question =====
    function showQuestion(idx) {
      D.questionContainer.innerHTML = `
        <label for="answer">${questions[idx] || ""}</label>
        <textarea id="answer" placeholder="Jawaban kamu..."></textarea>
      `;
      if (idx >= questions.length - 1) {
        D.nextBtn.style.display   = "none";
        D.submitBtn.style.display = "block";
      } else {
        D.nextBtn.style.display   = "block";
        D.submitBtn.style.display = "none";
      }
    }
    document.addEventListener("DOMContentLoaded", () => showQuestion(S.currentQuestion));

    D.nextBtn.addEventListener("click", () => {
      const answer = document.getElementById("answer").value.trim();
      if (!D.emailInput.value.trim() || !answer) return;
      S.tempAnswers[S.currentQuestion] = answer;
      S.currentQuestion++;
      showQuestion(S.currentQuestion);
    });

    // ===== LocalStorage clear =====
    D.clearLocalBtn.addEventListener("click", () => {
      const pass = prompt("Masukkan passcode untuk menghapus jawaban lokal:");
      if (pass !== "password") return alert("Passcode salah.");
      if (confirm("Hapus semua jawaban yang tersimpan?")) {
        localStorage.removeItem("responses");
        location.reload();
      }
    });

    // ===== Submit survey & AI overview =====
    D.form.addEventListener("submit", async e => {
      e.preventDefault();
      const fld = document.getElementById("answer");
      if (fld && fld.value.trim()) {
        S.tempAnswers[S.currentQuestion] = fld.value.trim();
      }
      const answers = [...S.tempAnswers];
      const email = D.emailInput.value.trim();
      if (!email || answers.length < questions.length) {
        return alert("Pastikan email & semua jawaban terisi.");
      }

      // save local
      S.allAnswers.push({ email, answers, time: new Date().toISOString() });
      localStorage.setItem("responses", JSON.stringify(S.allAnswers));

      // UI transition
      D.form.style.display          = "none";
      D.thankYouMessage.style.display = "block";

      // show loading sign
      D.aiOverview.innerHTML = `<p style="font-style:italic; text-align:center;">
        AI sedang membuat ringkasan dan rekomendasi kalori...</p>`;
      D.aiOverview.style.display = "block";

      // call Gemini for summary + calorie
      try {
        const prompt = 
          `Ringkas jawaban berikut (10 poin) dan berikan rekomendasi kalori harian untuk hidup sehat:\n\n` +
          answers.map((a,i)=>`${i+1}. ${a}`).join("\n");
        const url = 
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }] })
        });
        if (!resp.ok) throw new Error("API error");
        const data = await resp.json();
        const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        if (!aiText) throw new Error("Empty");

        D.aiOverview.innerHTML =
          `<h3>AI Overview</h3><p>${aiText.replace(/\n/g,"<br>")}</p>`;
      } catch (err) {
        D.aiOverview.innerHTML =
          `<p style="color:#d00; text-align:center;">AI gagal, coba lagi nanti.</p>`;
      }

      // show photo section next
      D.photoSection.style.display = "block";
    });

    // ===== Photo analysis =====
    D.photoSubmit.addEventListener("click", () => handlePhoto());

    async function handlePhoto() {
      const file = D.foodPhoto.files[0];
      if (!file) return alert("Pilih foto makanan terlebih dahulu.");
      // read as base64
      const reader = new FileReader();
      reader.onload = async () => {
        const b64 = reader.result.split(",")[1];
        D.photoAnalysis.innerHTML = `<p style="font-style:italic; text-align:center;">
          AI sedang menganalisis foto...</p>`;

        try {
          // Vision API: label detection
          const visionUrl = 
            `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;
          const visionResp = await fetch(visionUrl, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({
              requests:[{
                image:{ content:b64 },
                features:[{ type:"LABEL_DETECTION", maxResults:10 }]
              }]
            })
          });
          if (!visionResp.ok) throw new Error("Vision error");
          const vdata = await visionResp.json();
          const labels = vdata.responses[0].labelAnnotations
            .map(l=>l.description).join(", ");

          // Gemini: macro JSON + analysis
          const macroPrompt = 
            `Detected foods: ${labels}. ` +
            `Berikan distribusi makronutrien (protein, karbohidrat, lemak) dalam persen yang berjumlah 100%, ` +
            `dan analisis singkat makanan tersebut. ` +
            `Format jawaban sebagai JSON: {"protein":number,"carbohydrates":number,"fats":number,"analysis":string}.`;
          const gResp = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`, {
              method:"POST",
              headers:{ "Content-Type":"application/json" },
              body: JSON.stringify({ contents:[{ parts:[{ text:macroPrompt }] }] })
            }
          );
          if (!gResp.ok) throw new Error("Gemini error");
          const gdata = await gResp.json();
          let txt = gdata.candidates[0].content.parts[0].text;
          let obj;
          try { obj = JSON.parse(txt); }
          catch { throw new Error("Invalid JSON"); }

          // show analysis text
          D.photoAnalysis.innerHTML = `<h3>Analisis Foto</h3><p>${obj.analysis}</p>`;

          // draw pie chart
          const ctx = D.macroChart.getContext("2d");
          new Chart(ctx, {
            type: "pie",
            data: {
              labels: ["Protein","Carbohydrates","Fats"],
              datasets: [{
                data: [obj.protein, obj.carbohydrates, obj.fats],
                backgroundColor: ["#35a35c","#f5bc51","#e57373"]
              }]
            },
            options: { responsive: true, plugins:{ legend:{ position:"bottom" } } }
          });
        } catch (err) {
          console.warn(err);
          D.photoAnalysis.innerHTML = 
            `<p style="color:#d00; text-align:center;">Analisis foto gagal.</p>`;
        }
      };
      reader.readAsDataURL(file);
    }

    // ===== View all answers =====
    D.showAnswersBtn.addEventListener("click", () => {
      const pass = prompt("Masukkan password untuk melihat semua jawaban:");
      if (pass !== "rahasia123") return alert("Password salah.");
      let rows = S.allAnswers;
      if (!rows.length) return alert("Belum ada jawaban.");
      let html = `<table><tr><th>Email</th>${
        questions.map(q=>`<th>${q}</th>`).join("")}<th>Waktu</th></tr>`;
      rows.forEach(r => {
        html += `<tr><td>${r.email}</td>${
          r.answers.map(a=>`<td>${a}</td>`).join("")}<td>${r.time}</td></tr>`;
      });
      html += `</table>`;
      D.answersContainer.innerHTML = html;
      D.answersContainer.style.display = "block";
    });
  </script>
</body>
</html>
