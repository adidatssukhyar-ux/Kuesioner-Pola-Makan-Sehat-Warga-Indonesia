<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="container">
  <h1>Pola Makan Sehat Orang Indonesia</h1>

  <form id="wizardForm">
    <label for="email">Email kamu:</label>
    <input type="email" name="email" id="email" required placeholder="your@email.com" />
    <div id="questionContainer" style="margin-top:12px;"></div>
    <button type="button" id="nextBtn" style="margin-top:12px;">Next</button>
    <button type="submit" id="submitBtn" style="display:none; margin-top:12px;">Kirim</button>
  </form>

  <div id="thankYouMessage" style="display:none; cursor:pointer; margin-top:12px;">
    <span>Terimakasih telah menjawab, hasil anda akan dikirim ke email dalam waktu yang singkat</span><br />
    <span id="hiddenInfo" style="display:none; color:gray;">(maybe 2 days)</span>
  </div>

  <div id="aiOverview" style="display:none; margin-top:12px; padding:14px 16px; border:1px solid #ddd; border-radius:8px; background:linear-gradient(135deg,#ffffff,#f7f7f7); box-shadow:0 2px 6px rgba(0,0,0,0.05); font-size:14px; line-height:1.5em; color:#333;"></div>

  <hr />
  <button id="showAnswersBtn" type="button">ðŸ“‹ Lihat Semua Jawaban</button>
  <button id="clearLocalBtn" type="button" style="margin-left:8px;">ðŸ—‘ Hapus Jawaban Lokal</button>
  <div id="answersContainer" style="display:none; margin-top:10px;"></div>
</div>

<!-- Script 1: Always-render core -->
<script>
  const questions = [
    "1. Menurut kamu makanan junk food sehat atau tidak?",
    "2. Seberapa sering kamu mengonsumsi makanan junk food?",
    "3. Berapa kali kamu makan dalam sehari?",
    "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
    "5. Apakah kamu sering mengonsumsi sayur sayuran?",
    "6. Sebutkan makanan yang bergizi dan tidak bergizi",
    "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
    "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
    "9. Apakah kamu hari ini sudah sarapan?",
    "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
  ];

  window.__surveyState = {
    currentQuestion: 0,
    tempAnswers: [],
    allAnswers: JSON.parse(localStorage.getItem("responses") || "[]"),
  };

  const emailInput = document.getElementById("email");
  const questionContainer = document.getElementById("questionContainer");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const form = document.getElementById("wizardForm");
  const thankYouMessage = document.getElementById("thankYouMessage");
  const hiddenInfo = document.getElementById("hiddenInfo");
  const aiOverview = document.getElementById("aiOverview");
  const showAnswersBtn = document.getElementById("showAnswersBtn");
  const clearLocalBtn = document.getElementById("clearLocalBtn");
  const answersContainer = document.getElementById("answersContainer");

  function showQuestion(index) {
    const q = questions[index] ?? "";
    questionContainer.innerHTML = `
      <label for="answer">${q}</label>
      <textarea id="answer" placeholder="Jawaban kamu..." style="width:100%; min-height:110px; margin-top:8px;"></textarea>
    `;
    if (index >= questions.length - 1) {
      nextBtn.style.display = "none";
      submitBtn.style.display = "inline-block";
    } else {
      nextBtn.style.display = "inline-block";
      submitBtn.style.display = "none";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    showQuestion(window.__surveyState.currentQuestion);
  });

  nextBtn.addEventListener("click", () => {
    const s = window.__surveyState;
    const answerField = document.getElementById("answer");
    if (!emailInput.value.trim() || !answerField.value.trim()) return;
    s.tempAnswers[s.currentQuestion] = answerField.value.trim();
    s.currentQuestion++;
    showQuestion(s.currentQuestion);
  });

  thankYouMessage.addEventListener("click", () => {
    hiddenInfo.style.display = "inline";
  });

  // Clear local answers button
  clearLocalBtn.addEventListener("click", () => {
    if (confirm("Hapus semua jawaban yang tersimpan di browser ini?")) {
      localStorage.removeItem("responses");
      alert("Jawaban lokal dihapus.");
      location.reload();
    }
  });

  window.__surveyDOM = {
    emailInput,
    questionContainer,
    nextBtn,
    submitBtn,
    form,
    thankYouMessage,
    hiddenInfo,
    aiOverview,
    showAnswersBtn,
    answersContainer,
    showQuestion,
    questions
  };
</script>

<!-- Script 2: Firebase + Gemini + Viewer -->
<script type="module">
  const S = window.__surveyState;
  const D = window.__surveyDOM;

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAGxE7jKysNL097Ip_8_Xjr7pid3XNPCZY",
    authDomain: "surveylive-c0691.firebaseapp.com",
    projectId: "surveylive-c0691",
    storageBucket: "surveylive-c0691.firebasestorage.app",
    messagingSenderId: "894041077720",
    appId: "1:894041077720:web:2115a27b69e8b81ab724ad",
    measurementId: "G-83GZWBY7K5",
  };

  let db = null;
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
  } catch (e) {
    console.warn("Firebase init gagal.", e);
  }

  // Calorie helpers
  function guessDailyCalorie(answers) {
    const a1 = (answers[1] || "").toLowerCase();
    const a4 = (answers[4] || "").toLowerCase();
    const a8 = (answers[8] || "").toLowerCase();
    let low = 1800, high = 2200;
    if (/sering|tiap|setiap|hampir/.test(a1)) { low = 1700; high = 2100; }
    if (/sering|ya|tiap|setiap/.test(a4)) { low += 50; high += 100; }
    if (/ya|sudah/.test(a8)) { low += 50; high += 50; }
    low = Math.max(1600, Math.min(low, 2200));
    high = Math.max(low + 200, Math.min(high, 2400));
    return [low, high];
  }
  function splitMeals(totalLow, totalHigh) {
    const pct = { b: 0.25, l: 0.35, d: 0.30, s: 0.10 };
    const fmt = (x) => Math.round(x);
    return {
      low: { b: fmt(totalLow * pct.b), l: fmt(totalLow * pct.l), d: fmt(totalLow * pct.d), s: fmt(totalLow * pct.s) },
      high: { b: fmt(totalHigh * pct.b), l: fmt(totalHigh * pct.l), d: fmt(totalHigh * pct.d), s: fmt(totalHigh * pct.s) }
    };
  }
  function sampleMenus() {
    return [
      { name: "Sarapan: Oatmeal + pisang + susu rendah lemak", kcal: 350 },
      { name: "Makan siang: Nasi merah 150g +
