<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ML5.js, Chart.js & Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.6.0/dist/ml5.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js" defer></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #e5ffe5 0%, #fffbe5 100%);
      color: #333;
    }
    .container {
      width: 100%; max-width: 500px;
      margin: 40px auto;
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    .header-logo img {
      display: block;
      margin: 0 auto 12px;
      width: 80px;
      border-radius: 8px;
    }
    .project-credit {
      text-align: center;
      color: #666;
      margin: 12px 0;
      font-size: 0.9em;
    }
    h1 {
      font-size: 1.8em;
      text-align: center;
      color: #35a35c;
      margin-bottom: 16px;
    }
    h2 {
      font-size: 1.4em;
      text-align: center;
      color: #35a35c;
      margin-bottom: 12px;
    }
    section { display: none; }
    section.active { display: block; }

    label {
      display: block;
      margin-top: 16px;
      font-weight: 600;
      color: #22753e;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1.5px solid #f5bc51;
      border-radius: 8px;
      background: #fffde9;
      font-size: 1em;
    }
    textarea { min-height: 80px; resize: vertical; }
    input:focus, textarea:focus { outline: none; border-color: #35a35c; }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      background: linear-gradient(90deg, #35a35c 40%, #f5bc51 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
    }
    button:hover {
      background: linear-gradient(90deg, #22753e 30%, #e9b742 100%);
    }

    .question-text {
      margin-top: 16px;
      font-size: 1.1em;
      color: #22753e;
      font-weight: 600;
    }

    .analysis-flex {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-top: 16px;
    }
    .analysis-photo, .analysis-list {
      flex: 1;
      min-width: 200px;
      position: relative;
    }

    #foodPreview {
      display: none;
      margin-top: 12px;
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .warning {
      display: none;
      margin-top: 12px;
      padding: 10px;
      background: #fff3cd;
      color: #856404;
      border-left: 4px solid #ffeeba;
      border-radius: 4px;
    }

    .food-list {
      margin-top: 8px;
      max-height: 200px;
      overflow-y: auto;
      border: 1.5px solid #b5e7b7;
      border-radius: 8px;
      background: #fffde9;
    }
    .food-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }
    .food-item:last-child { border-bottom: none; }
    .food-item:hover {
      background: rgba(53,163,92,0.1);
    }

    #foodDetailPanel {
      display: none;
      margin-top: 8px;
      border: 1px solid #b5e7b7;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .close-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: none; border: none;
      font-size: 1.2em; cursor: pointer; color: #666;
    }

    canvas {
      max-width: 100%;
      height: 140px;
      margin-top: 16px;
    }

    .spinner-overlay {
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(255,255,255,0.7);
      display: flex; align-items: center; justify-content: center;
      visibility: hidden;
    }
    .spinner-overlay.active {
      visibility: visible;
    }
    .spinner {
      width: 40px; height: 40px;
      border: 5px solid #f5bc51;
      border-top-color: #35a35c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-logo">
      <img src="https://yt3.ggpht.com/a/AATXAJwRp9NDxa9WX7nh8uuO9TUCUCMqCRE5yJp4CQ=s900-c-k-c0xffffffff-no-rj-mo"
           alt="Logo Sekolah Al Ikhlas">
    </div>
    <h1>Pola Makan Sehat</h1>

    <section id="step1" class="active">
      <div id="questionContainer"></div>
      <div class="project-credit">Karya Kelompok 1 — Proyek 1</div>
      <button id="step1Next">Next</button>
    </section>

    <section id="step2">
      <h2>Overview AI</h2>
      <div id="aiOverview" style="min-height:80px;"></div>
      <button id="step2Next">Lanjut ke Foto</button>
    </section>

    <section id="step3">
      <h2>Analisis Foto & Makanan</h2>
      <div class="analysis-flex">
        <div class="analysis-photo">
          <label for="imageUrl">URL Foto (opsional):</label>
          <input type="url" id="imageUrl" placeholder="https://..." />
          <label for="foodPhoto">Pilih File:</label>
          <input type="file" id="foodPhoto" accept="image/*" />
          <button id="photoSubmit">Analisis Foto</button>

          <img id="foodPreview" alt="Preview Gambar">

          <div id="warningSign" class="warning">
            ⚠️ <span>Kalori terlalu rendah. Pertimbangkan menambah porsi.</span>
          </div>

          <div id="photoAnalysis" style="min-height:50px;"></div>
          <canvas id="macroPie"></canvas>
          <canvas id="macroBar"></canvas>
        </div>

        <div class="analysis-list">
          <h2>Pilih Makanan</h2>
          <input type="text" id="foodSearchRight" placeholder="Cari makanan..." />
          <div id="foodDetailPanel">
            <button class="close-btn">&times;</button>
            <div id="foodDetails"></div>
          </div>
          <div id="foodListRight" class="food-list"></div>
        </div>
      </div>
    </section>
  </div>

  <div id="spinner" class="spinner-overlay">
    <div class="spinner"></div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Questions & state
    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur-sayuran?",
      "6. Sebutkan satu makanan bergizi dan satu yang tidak bergizi.",
      "7. Menurut kamu, seberapa penting nutrisi seimbang?",
      "8. Buah atau sayur mana yang paling sering kamu konsumsi?",
      "9. Apa tantanganmu untuk makan lebih sehat?",
      "10. Langkah apa yang akan kamu ambil untuk pola makan lebih baik?"
    ];
    let idx = 0, answers = [];

    // Macro database
    const macroDBList = [
      { key:"apple", name:"Apel", protein:0.3, carbs:14, fats:0.2, energy:52 },
      { key:"banana", name:"Pisang", protein:1.3, carbs:23, fats:0.3, energy:96 },
      { key:"rice",   name:"Nasi Putih", protein:2.7, carbs:28, fats:0.3, energy:130 },
      { key:"sushi",  name:"Sushi", protein:6, carbs:36, fats:1.5, energy:200 },
      { key:"salad",  name:"Salad", protein:2, carbs:5, fats:0.2, energy:35 }
    ];
    const macroDB = Object.fromEntries(macroDBList.map(o=>[o.key,o]));

    // Refs
    const step1 = document.getElementById("step1");
    const step2 = document.getElementById("step2");
    const step3 = document.getElementById("step3");
    const qC     = document.getElementById("questionContainer");
    const b1     = document.getElementById("step1Next");
    const b2     = document.getElementById("step2Next");
    const aiDiv  = document.getElementById("aiOverview");
    const spinner= document.getElementById("spinner");

    const imgUrl  = document.getElementById("imageUrl");
    const fileInp = document.getElementById("foodPhoto");
    const pBtn    = document.getElementById("photoSubmit");
    const preview = document.getElementById("foodPreview");
    const warnEl  = document.getElementById("warningSign");
    const analysis= document.getElementById("photoAnalysis");
    const pieCan  = document.getElementById("macroPie");
    const barCan  = document.getElementById("macroBar");

    const foodSearch = document.getElementById("foodSearchRight");
    const foodList   = document.getElementById("foodListRight");
    const detailPanel= document.getElementById("foodDetailPanel");
    const foodDetails= document.getElementById("foodDetails");
    const closeBtn   = detailPanel.querySelector(".close-btn");

    // Show survey question
    function showQuestion(i) {
      qC.innerHTML = `
        <p class="question-text">${questions[i]}</p>
        <textarea id="answer" placeholder="Tuliskan jawaban...">${answers[i]||""}</textarea>
      `;
      b1.textContent = i < questions.length-1 ? "Next" : "Submit";
    }
    showQuestion(idx);

    // Step1 → Step2 (AI)
    b1.addEventListener("click", async () => {
      const ans = document.getElementById("answer").value.trim();
      if (!ans) return alert("Isi jawaban dulu.");
      answers[idx] = ans;
      if (idx < questions.length-1) {
        idx++; showQuestion(idx);
      } else {
        confetti({ particleCount:100, spread:60, origin:{ y:0.3 } });
        step1.classList.remove("active");
        step1.classList.add("hidden");
        step2.classList.add("active");
        aiDiv.innerHTML = "<em>Memuat overview AI…</em>";
        spinner.classList.add("active");
        const prompt = answers.map((a,i)=>`${questions[i]}\nJawaban: ${a}`).join("\n\n");
        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=YOUR_API_KEY`,
            {
              method:"POST",
              headers:{"Content-Type":"application/json"},
              body: JSON.stringify({
                contents:[{ parts:[{ text:`Ringkas pola makan:\n\n${prompt}` }] }]
              })
            }
          );
          const j = await res.json();
          aiDiv.innerHTML = `<p>${(j.candidates?.[0]?.content?.parts?.[0]?.text||"AI gagal.").replace(/\n/g,"<br>")}</p>`;
        } catch {
          aiDiv.innerHTML = "<p style='color:red'>Error memuat AI overview.</p>";
        } finally {
          spinner.classList.remove("active");
        }
      }
    });

    // Step2 → Step3 (Photo)
    b2.addEventListener("click", () => {
      step2.classList.remove("active");
      step2.classList.add("hidden");
      step3.classList.add("active");
      buildFoodList();
    });

    // Build list of foods
    function buildFoodList() {
      detailPanel.style.display = "none";
      foodList.innerHTML = "";
      foodSearch.value = "";
      macroDBList.forEach(item => {
        const div = document.createElement("div");
        div.className = "food-item";
        div.textContent = item.name;
        div.onclick = () => showFoodDetail(item);
        foodList.append(div);
      });
    }

    // Search filter
    foodSearch.addEventListener("input", () => {
      const q = foodSearch.value.toLowerCase();
      document.querySelectorAll(".food-item").forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
      });
      detailPanel.style.display = "none";
    });

    // Show food detail panel
    function showFoodDetail(item) {
      foodDetails.innerHTML = `
        <h4>${item.name}</h4>
        <p>Protein: ${item.protein} g</p>
        <p>Karbo: ${item.carbs} g</p>
        <p>Lemak: ${item.fats} g</p>
        <p>Energi: ${item.energy} kcal</p>
      `;
      detailPanel.style.display = "block";
    }
    closeBtn.onclick = () => detailPanel.style.display = "none";

    // Photo analysis handler
    pBtn.addEventListener("click", async () => {
      let src = imgUrl.value.trim();
      if (!src && fileInp.files[0]) {
        src = URL.createObjectURL(fileInp.files[0]);
      }
      if (!src) return alert("Masukkan URL atau pilih file.");

      preview.src = src;
      preview.style.display = "block";
      warnEl.style.display = "none";
      analysis.textContent = "";
      spinner.classList.add("active");

      const classifier = await ml5.imageClassifier("MobileNet");
      const [res] = await classifier.classify(preview);
      const key = res.label.split(",")[0].toLowerCase();
      const info = macroDB[key] || { name: key, protein:0, carbs:0, fats:0, energy:0 };

      if (info.energy < 150) {
        warnEl.style.display = "block";
      }

      // Chart data
      const totalMacro = info.protein + info.carbs + info.fats || 1;
      const dataPie = [
        Math.round(info.protein/totalMacro*100),
        Math.round(info.carbs/totalMacro*100),
        Math.round(info.fats/totalMacro*100)
      ];

      renderPie(dataPie, ["Protein","Karbo","Lemak"], pieCan);
      renderBar(
        [info.protein, info.carbs, info.fats, info.energy],
        ["Protein(g)","Karbo(g)","Lemak(g)","Energi(kcal)"],
        barCan
      );

      analysis.innerHTML = `<p><strong>${info.name}</strong>: ${info.energy} kcal — P ${info.protein}g, C ${info.carbs}g, L ${info.fats}g</p>`;
      spinner.classList.remove("active");
    });

    // Chart helpers
    function clearChart(canvas) {
      if (canvas._chart) canvas._chart.destroy();
    }
    function renderPie(data, labels, canvas) {
      clearChart(canvas);
      canvas._chart = new Chart(canvas.getContext("2d"), {
        type: "pie",
        data: { labels, datasets: [{ data, backgroundColor: ["#35a35c","#f5bc51","#e57373"] }] },
        options: { responsive: true, plugins: { legend: { position: "bottom" } } }
      });
    }
    function renderBar(data, labels, canvas) {
      clearChart(canvas);
      canvas._chart = new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: { labels, datasets: [{ data, backgroundColor: ["#35a35c","#f5bc51","#e57373","#5c97f5"] }] },
        options: { indexAxis: "y", responsive: true }
      });
    }
  });
  </script>
</body>
</html>
