<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<div class="container">
  <h1>Pola Makan Sehat Orang Indonesia</h1>

  <form id="wizardForm">
    <label for="email">Email kamu:</label>
    <input type="email" name="email" id="email" required placeholder="your@email.com" />
    <div id="questionContainer" style="margin-top:12px;"></div>
    <button type="button" id="nextBtn" style="margin-top:12px;">Next</button>
    <button type="submit" id="submitBtn" style="display:none; margin-top:12px;">Kirim</button>
  </form>

  <div id="thankYouMessage" style="display:none; cursor:pointer; margin-top:12px;">
    <span>Terimakasih telah menjawab, hasil anda akan dikirim ke email dalam waktu yang singkat</span><br />
    <span id="hiddenInfo" style="display:none; color:gray;">(maybe 2 days)</span>
  </div>

  <div id="aiOverview" style="display:none; margin-top:12px; padding:14px 16px; border:1px solid #ddd; border-radius:8px; background:linear-gradient(135deg,#ffffff,#f7f7f7); box-shadow:0 2px 6px rgba(0,0,0,0.05); font-size:14px; line-height:1.5em; color:#333;"></div>

  <hr />
  <button id="showAnswersBtn" type="button">ðŸ“‹ Lihat Semua Jawaban</button>
  <button id="clearLocalBtn" type="button" style="margin-left:8px;">ðŸ—‘ Hapus Jawaban Lokal</button>
  <div id="answersContainer" style="display:none; margin-top:10px; overflow:auto;"></div>
</div>

<!-- Script 1: Always-render core (no imports) -->
<script>
  // Pertanyaan survei (mudah diedit)
  const questions = [
    "1. Menurut kamu makanan junk food sehat atau tidak?",
    "2. Seberapa sering kamu mengonsumsi makanan junk food?",
    "3. Berapa kali kamu makan dalam sehari?",
    "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
    "5. Apakah kamu sering mengonsumsi sayur sayuran?",
    "6. Sebutkan makanan yang bergizi dan tidak bergizi",
    "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
    "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
    "9. Apakah kamu hari ini sudah sarapan?",
    "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
  ];

  // State global yang juga dipakai Script 2
  window.__surveyState = {
    currentQuestion: 0,
    tempAnswers: [],
    allAnswers: JSON.parse(localStorage.getItem("responses") || "[]"),
  };

  // DOM refs
  const emailInput = document.getElementById("email");
  const questionContainer = document.getElementById("questionContainer");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const form = document.getElementById("wizardForm");
  const thankYouMessage = document.getElementById("thankYouMessage");
  const hiddenInfo = document.getElementById("hiddenInfo");
  const aiOverview = document.getElementById("aiOverview");
  const showAnswersBtn = document.getElementById("showAnswersBtn");
  const clearLocalBtn = document.getElementById("clearLocalBtn");
  const answersContainer = document.getElementById("answersContainer");

  // Render satu pertanyaan
  function showQuestion(index) {
    const q = questions[index] ?? "";
    questionContainer.innerHTML = `
      <label for="answer">${q}</label>
      <textarea id="answer" placeholder="Jawaban kamu..." style="width:100%; min-height:110px; margin-top:8px;"></textarea>
    `;
    if (index >= questions.length - 1) {
      nextBtn.style.display = "none";
      submitBtn.style.display = "inline-block";
    } else {
      nextBtn.style.display = "inline-block";
      submitBtn.style.display = "none";
    }
  }

  // Initial render
  document.addEventListener("DOMContentLoaded", () => {
    showQuestion(window.__surveyState.currentQuestion);
  });

  // Tombol Next
  nextBtn.addEventListener("click", () => {
    const s = window.__surveyState;
    const answerField = document.getElementById("answer");
    if (!emailInput.value.trim() || !answerField.value.trim()) return;
    s.tempAnswers[s.currentQuestion] = answerField.value.trim();
    s.currentQuestion++;
    showQuestion(s.currentQuestion);
  });

  // Pesan terima kasih: reveal
  thankYouMessage.addEventListener("click", () => {
    hiddenInfo.style.display = "inline";
  });

  // Tombol hapus jawaban lokal (dengan passcode)
  clearLocalBtn.addEventListener("click", () => {
    const pass = prompt("Masukkan passcode untuk menghapus jawaban lokal:");
    if (pass !== "password") {
      alert("Passcode salah. Jawaban lokal tidak dihapus.");
      return;
    }
    if (confirm("Hapus semua jawaban yang tersimpan di browser ini?")) {
      localStorage.removeItem("responses");
      alert("Jawaban lokal dihapus.");
      location.reload();
    }
  });

  // Ekspor ke Script 2
  window.__surveyDOM = {
    emailInput,
    questionContainer,
    nextBtn,
    submitBtn,
    form,
    thankYouMessage,
    hiddenInfo,
    aiOverview,
    showAnswersBtn,
    answersContainer,
    showQuestion,
    questions
  };
</script>

<!-- Script 2: Enhancements (Firebase, Gemini, viewer) -->
<script type="module">
  const S = window.__surveyState;
  const D = window.__surveyDOM;

  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyAGxE7jKysNL097Ip_8_Xjr7pid3XNPCZY",
    authDomain: "surveylive-c0691.firebaseapp.com",
    projectId: "surveylive-c0691",
    storageBucket: "surveylive-c0691.firebasestorage.app",
    messagingSenderId: "894041077720",
    appId: "1:894041077720:web:2115a27b69e8b81ab724ad",
    measurementId: "G-83GZWBY7K5",
  };

  // Init Firebase (best-effort)
  let db = null;
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
  } catch (e) {
    console.warn("Firebase init gagal. Lanjutkan dengan penyimpanan lokal saja.");
  }

  // ===== Calorie helpers & offline fallback =====
  function guessDailyCalorie(answers) {
    // Heuristik ringan berdasar jawaban
    const freqJunk = (answers[1] || "").toLowerCase(); // Q2
    const vegOften = (answers[4] || "").toLowerCase(); // Q5
    const breakfast = (answers[8] || "").toLowerCase(); // Q9

    let low = 1800, high = 2200; // rentang umum aman (edukasi)
    if (/sering|tiap|setiap|hampir/.test(freqJunk)) { low = 1700; high = 2100; }
    if (/sering|ya|tiap|setiap/.test(vegOften)) { low += 50; high += 100; }
    if (/ya|sudah/.test(breakfast)) { low += 50; high += 50; }

    low = Math.max(1600, Math.min(low, 2200));
    high = Math.max(low + 200, Math.min(high, 2400));
    return [low, high];
  }

  function splitMeals(totalLow, totalHigh) {
    // Sarapan 25%, Siang 35%, Malam 30%, Snack 10%
    const pct = { b: 0.25, l: 0.35, d: 0.30, s: 0.10 };
    const fmt = (x) => Math.round(x);
    return {
      low: {
        b: fmt(totalLow * pct.b),
        l: fmt(totalLow * pct.l),
        d: fmt(totalLow * pct.d),
        s: fmt(totalLow * pct.s)
      },
      high: {
        b: fmt(totalHigh * pct.b),
        l: fmt(totalHigh * pct.l),
        d: fmt(totalHigh * pct.d),
        s: fmt(totalHigh * pct.s)
      }
    };
  }

  function sampleMenus() {
    // Estimasi kasar, edukatif
    return [
      { name: "Sarapan: Oatmeal + pisang + susu rendah lemak", kcal: 350 },
      { name: "Makan siang: Nasi merah 150g + ayam panggang 120g + tumis buncis", kcal: 600 },
      { name: "Makan malam: Gado-gado tanpa kerupuk + telur rebus", kcal: 500 },
      { name: "Snack: Yogurt tawar + buah potong / kacang panggang", kcal: 150 }
    ];
  }

  function localFallbackCalorieBlock(answers) {
    const [low, high] = guessDailyCalorie(answers);
    const split = splitMeals(low, high);
    const menus = sampleMenus();
    return `
<strong>ðŸ”¥ Rekomendasi Kalori (offline):</strong><br>
â€¢ Target harian: sekitar ${low}â€“${high} kkal (asumsi dewasa; tanpa data tubuh/aktivitas).<br>
â€¢ Pembagian makan: Sarapan ${split.low.b}â€“${split.high.b} kkal | Siang ${split.low.l}â€“${split.high.l} kkal | Malam ${split.low.d}â€“${split.high.d} kkal | Snack ${split.low.s}â€“${split.high.s} kkal<br>
â€¢ Contoh menu:<br>
${menus.map(m => "â€” " + m.name + " (~" + m.kcal + " kkal)").join("<br>")}
<br><em>Catatan: Perkiraan edukatif, bukan saran medis.</em>
`.trim();
  }

  // ===== Gemini Overview with calorie recommendations =====
  function buildShortPrompt(questions, answers) {
    const pairs = answers.map((ans, i) => Q${i+1}: ${ans}).join("\n");
    return Ringkas jawaban, lalu berikan rekomendasi kalori harian (rentang) + pembagian per makan (sarapan/siang/malam/snack) + 2â€“3 menu sehat Indonesia dengan estimasi kalori. Batas 150 kata, bahasa Indonesia, ramah, praktis.\n${pairs};
  }

  async function generateOverview(answers = []) {
    const qa = answers.map((ans, i) => ${i+1}. ${D.questions[i]} Jawaban: ${ans}).join("\n");
    const prompt = `
Tujuan: Ringkasan pola makan + rekomendasi kalori untuk edukasi.
Instruksi:
1) Ringkas kebiasaan secara singkat.
2) Berikan rekomendasi kalori harian dalam rentang (contoh: 1800â€“2200 kkal) dengan catatan asumsi.
3) Pembagian kalori: sarapan 25%, siang 35%, malam 30%, snack 10% (kisaran).
4) 2â€“3 contoh menu sehat khas Indonesia dengan estimasi kalori per menu.
5) Nada ramah, tidak menghakimi, â‰¤170 kata, bahasa Indonesia.
Data pengguna:
${qa}
`.trim();

    // Tampilkan loading
    D.aiOverview.style.display = "block";
    D.aiOverview.innerHTML = "â³ Membuat ringkasan & rekomendasi kalori...";

    const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyBPcdZLEOAb7zgjtj5Tu9lzQBD1SAFayDQ";
    const body = (text) => ({
      contents: [{ parts: [{ text }] }],
      generationConfig: { temperature: 0.7, maxOutputTokens: 380 }
    });

    // Coba 1
    try {
      const r1 = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body(prompt))
      });
      const d1 = await r1.json();
      const t1 = d1?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
      if (t1) return <strong>ðŸ“Š Ringkasan & Saran + Kalori:</strong><br>${t1};
    } catch (_) {}

    // Coba 2 (prompt pendek)
    try {
      const r2 = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body(buildShortPrompt(D.questions, answers)))
      });
      const d2 = await r2.json();
      const t2 = d2?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
      if (t2) return <strong>ðŸ“Š Ringkasan & Saran + Kalori:</strong><br>${t2};
    } catch (_) {}

    // Fallback offline terjamin
    return localFallbackCalorieBlock(answers);
  }

  // ===== Submit handler (save + AI) =====
  D.form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const s = S;
    const answerField = document.getElementById("answer");
    if (!answerField?.value?.trim()) return;

    // Simpan jawaban terakhir
    s.tempAnswers[s.currentQuestion] = answerField.value.trim();

    // Simpan lokal
    s.allAnswers.push({
      email: D.emailInput.value.trim(),
      answers: [...s.tempAnswers],
      timestamp: new Date().toISOString()
    });
    localStorage.setItem("responses", JSON.stringify(s.allAnswers));

    // Simpan Firebase (best-effort)
    if (db) {
      try {
        await addDoc(collection(db, "responses"), {
          email: D.emailInput.value.trim(),
          answers: [...s.tempAnswers],
          timestamp: new Date()
        });
      } catch (err) {
        console.warn("Gagal menyimpan ke Firebase. Tetap lanjut dengan data lokal.");
      }
    }

    // Tampilkan terima kasih + AI
    D.thankYouMessage.style.display = "block";
    D.aiOverview.innerHTML = await generateOverview(s.tempAnswers);
    D.aiOverview.style.display = "block";

    // Reset untuk responden berikutnya
    D.form.reset();
    S.currentQuestion = 0;
    S.tempAnswers = [];
    D.showQuestion(S.currentQuestion);
  });

  // ===== Viewer (password: rahasia123) =====
  D.showAnswersBtn.addEventListener("click", async () => {
    const pass = prompt("Masukkan password untuk melihat jawaban:");
    if (pass !== "rahasia123") {
      alert("Password salah!");
      return;
    }

    // Gabungkan lokal + cloud (jika ada)
    let combined = Array.isArray(S.allAnswers) ? [...S.allAnswers] : [];

    if (db) {
      try {
        const q = query(collection(db, "responses"), orderBy("timestamp"));
        const snapshot = await getDocs(q);
        snapshot.forEach((doc) => combined.push(doc.data()));
      } catch (err) {
        console.warn("Tidak bisa memuat dari Firebase, tampilkan lokal saja.");
      }
    }

    // Render tabel
    if (!combined.length) {
      D.answersContainer.innerHTML = "<p>Belum ada jawaban yang masuk.</p>";
    } else {
      let html = "<table border='1' cellspacing='0' cellpadding='6' style='min-width:720px;'>";
      html += "<tr><th>Email</th><th>Jawaban</th><th>Waktu</th></tr>";
      combined.forEach((row) => {
        const safeEmail = (row?.email ?? "").toString();
        const safeAns = Array.isArray(row?.answers) ? row.answers.join(" | ") : "";
        const t = row?.timestamp ? new Date(row.timestamp).toLocaleString() : "-";
        html += <tr><td>${safeEmail}</td><td>${safeAns}</td><td>${t}</td></tr>;
      });
      html += "</table>";
      D.answersContainer.innerHTML = html;
    }
    D.answersContainer.style.display = "block";
  });
</script>
</body>
</html>
```
