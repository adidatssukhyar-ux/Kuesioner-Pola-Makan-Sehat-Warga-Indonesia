<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Pola Makan Sehat Orang Indonesia</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Pola Makan Sehat Orang Indonesia</h1>
    <form id="wizardForm">
      <label for="email">Email kamu:</label>
      <input type="email" name="email" id="email" required placeholder="your@email.com">
      <div id="questionContainer"></div>
      <button type="button" id="nextBtn">Next</button>
      <button type="submit" id="submitBtn" style="display:none;">Kirim</button>
    </form>

    <div id="thankYouMessage" style="display:none; cursor:pointer; margin-top:12px;">
      <span>Terimakasih telah menjawab, hasil anda akan dikirim ke email dalam waktu yang singkat</span><br>
      <span id="hiddenInfo" style="display:none; color:gray;">(maybe 2 days)</span>
    </div>

    <!-- AI Overview -->
    <div id="aiOverview" style="display:none; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:5px; background:#f9f9f9;"></div>

    <hr>
    <button id="showAnswersBtn" type="button">📋 Lihat Semua Jawaban</button>
    <div id="answersContainer" style="display:none; margin-top:10px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy } 
      from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAGxE7jKysNL097Ip_8_Xjr7pid3XNPCZY",
      authDomain: "surveylive-c0691.firebaseapp.com",
      projectId: "surveylive-c0691",
      storageBucket: "surveylive-c0691.firebasestorage.app",
      messagingSenderId: "894041077720",
      appId: "1:894041077720:web:2115a27b69e8b81ab724ad",
      measurementId: "G-83GZWBY7K5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi makanan junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur sayuran?",
      "6. Sebutkan makanan yang bergizi dan tidak bergizi",
      "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
      "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
      "9. Apakah kamu hari ini sudah sarapan?",
      "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
    ];

    let currentQuestion = 0;
    let tempAnswers = [];
    let allAnswers = JSON.parse(localStorage.getItem("responses") || "[]");

    const emailInput = document.getElementById('email');
    const questionContainer = document.getElementById('questionContainer');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const thankYouMessage = document.getElementById('thankYouMessage');
    const hiddenInfo = document.getElementById('hiddenInfo');
    const aiOverview = document.getElementById('aiOverview');
    const form = document.getElementById('wizardForm');
    const showAnswersBtn = document.getElementById('showAnswersBtn');
    const answersContainer = document.getElementById('answersContainer');

    function showQuestion(index) {
      questionContainer.innerHTML = `
        <label for="answer">${questions[index]}</label>
        <textarea id="answer" placeholder="Jawaban kamu..."></textarea>
      `;
      if (index === questions.length - 1) {
        nextBtn.style.display = "none";
        submitBtn.style.display = "inline-block";
      } else {
        nextBtn.style.display = "inline-block";
        submitBtn.style.display = "none";
      }
    }

    showQuestion(currentQuestion);

    nextBtn.addEventListener('click', () => {
      const answerField = document.getElementById('answer');
      if (!emailInput.value.trim() || !answerField.value.trim()) return;
      tempAnswers[currentQuestion] = answerField.value.trim();
      currentQuestion++;
      showQuestion(currentQuestion);
    });

    // Smarter AI Overview
    function smartOverview(answers) {
      const a = (i) => (answers[i] || "").toLowerCase();
      let score = 0;
      let issues = [];

      // Junk food opinion
      if (a(0).includes("sehat")) { score -= 2; issues.push("Menganggap junk food sehat"); }
      else if (a(0)) { score += 1; }

      // Junk food frequency
      if (a(1).includes("sering")) { score -= 1; issues.push("Sering makan junk food"); }
      else if (a(1).includes("jarang") || a(1).includes("tidak")) { score += 1; }

      // Soda
      if (a(3).includes("sering")) { score -= 1; issues.push("Sering minum soda/manis"); }
      else if (a(3)) { score += 1; }

      // Sayur
      if (a(4).includes("tidak") || a(4).includes("jarang")) { score -= 1; issues.push("Kurang sayur/buah"); }
      else if (a(4)) { score += 1; }

      // Sarapan
      if (a(8).includes("tidak")) { score -= 1; issues.push("Tidak sarapan"); }
      else if (a(8)) { score += 1; }

      // Summary tone
      let summary;
      if (score <= -2) summary = "⚠️ Pola makan kamu perlu banyak perbaikan.";
      else if (score <= 2) summary = "🙂 Pola makan kamu cukup, tapi masih bisa ditingkatkan.";
      else summary = "🌟 Pola makan kamu sudah sangat baik — pertahankan!";

      // Advice
      let advice = [];
      if (issues.includes("Menganggap junk food sehat")) advice.push("Kurangi konsumsi junk food, pilih makanan segar.");
      if (issues.includes("Sering makan junk food")) advice.push("Batasi junk food, ganti dengan makanan bergizi.");
      if (issues.includes("Sering minum soda/manis")) advice.push("Ganti minuman manis dengan air putih.");
      if (issues.includes("Kurang sayur/buah")) advice.push("Perbanyak sayur dan buah setiap hari.");
      if (issues.includes("Tidak sarapan")) advice.push("Biasakan sarapan untuk energi dan konsentrasi.");
      if (advice.length === 0) advice.push("Pertahankan kebiasaan sehatmu dan terus aktif bergerak.");

      return `<strong>📊 Ringkasan & Saran:</strong><br>${summary}<br>- ${advice.join("<br>- ")}`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const answerField = document.getElementById('answer');
      if (!answerField.value.trim()) return;
      tempAnswers[currentQuestion] = answerField.value.trim();

      // Save locally
      allAnswers.push({ email: emailInput.value.trim(), answers: [...tempAnswers] });
      localStorage.setItem("responses", JSON.stringify(allAnswers));

      // Try Firebase save
      try {
        await addDoc(collection(db, "responses"), {
          email: emailInput.value.trim(),
          answers: [...tempAnswers],
          timestamp: new Date()
        });
      } catch (err) {
        alert("⚠ Data disimpan lokal. Firebase gagal menyimpan.");
      }

      // Show thank you + AI overview
      thankYouMessage.style.display = 'block';
      aiOverview.innerHTML = smartOverview(tempAnswers);
      aiOverview.style.display = 'block';

      // Reset for next run
      form.reset();
      currentQuestion = 0;
      tempAnswers = [];
