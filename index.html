<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Pola Makan Sehat Orang Indonesia</h1>

    <form id="wizardForm" autocomplete="off">
      <label for="email">Email kamu:</label>
      <input type="email" id="email" placeholder="nama@contoh.com" required />

      <div id="questionContainer"></div>

      <button type="button" id="nextBtn">Next</button>
      <button type="button" id="showAnswersBtn">ðŸ“‹ Lihat Semua Jawaban</button>
      <button type="button" id="clearLocalBtn">ðŸ—‘ Hapus Jawaban Lokal</button>
      <button type="submit" id="submitBtn" style="display:none;">Kirim</button>
    </form>

    <div id="thankYouMessage" style="display:none; cursor:pointer;">
      Terimakasih telah menjawab, hasil anda akan dikirim ke email dalam waktu yang singkat
      <span id="hiddenInfo" class="final-message" style="display:none;">(maybe 2 days)</span>
    </div>

    <div id="aiOverview" style="display:none; margin-top:16px;"></div>
    <div id="answersContainer" style="display:none; margin-top:16px; overflow:auto;"></div>
  </div>

  <script type="module">
    // ===== Data & State =====
    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi makanan junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur sayuran?",
      "6. Sebutkan makanan yang bergizi dan tidak bergizi",
      "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
      "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
      "9. Apakah kamu hari ini sudah sarapan?",
      "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
    ];
    const S = {
      currentQuestion: 0,
      tempAnswers: [],
      allAnswers: JSON.parse(localStorage.getItem("responses") || "[]"),
    };

    // ===== DOM Refs =====
    const D = {
      emailInput: document.getElementById("email"),
      questionContainer: document.getElementById("questionContainer"),
      nextBtn: document.getElementById("nextBtn"),
      submitBtn: document.getElementById("submitBtn"),
      form: document.getElementById("wizardForm"),
      thankYouMessage: document.getElementById("thankYouMessage"),
      hiddenInfo: document.getElementById("hiddenInfo"),
      aiOverview: document.getElementById("aiOverview"),
      showAnswersBtn: document.getElementById("showAnswersBtn"),
      clearLocalBtn: document.getElementById("clearLocalBtn"),
      answersContainer: document.getElementById("answersContainer"),
    };

    // ===== Wizard Flow =====
    function showQuestion(idx) {
      D.questionContainer.innerHTML = `
        <label for="answer">${questions[idx] || ""}</label>
        <textarea id="answer" placeholder="Jawaban kamu..."></textarea>
      `;
      if (idx >= questions.length - 1) {
        D.nextBtn.style.display = "none";
        D.submitBtn.style.display = "block";
      } else {
        D.nextBtn.style.display = "block";
        D.submitBtn.style.display = "none";
      }
    }
    document.addEventListener("DOMContentLoaded", () => showQuestion(S.currentQuestion));

    D.nextBtn.addEventListener("click", () => {
      const ans = document.getElementById("answer").value.trim();
      if (!D.emailInput.value.trim() || !ans) return;
      S.tempAnswers[S.currentQuestion] = ans;
      S.currentQuestion++;
      showQuestion(S.currentQuestion);
    });

    D.thankYouMessage.addEventListener("click", () => {
      D.hiddenInfo.style.display = "inline";
    });

    // ===== LocalStorage Clear =====
    D.clearLocalBtn.addEventListener("click", () => {
      const pass = prompt("Masukkan passcode untuk menghapus jawaban lokal:");
      if (pass !== "password") return alert("Passcode salah.");
      if (confirm("Hapus semua jawaban yang tersimpan?")) {
        localStorage.removeItem("responses");
        alert("Jawaban lokal dihapus.");
        location.reload();
      }
    });

    // ===== Firebase Init =====
    let db = null;
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js");
      const { getFirestore, collection, addDoc, getDocs, query, orderBy } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js");
      const cfg = {
        apiKey: "AIzaSyDIVFI3M-283v1Ume5ivh3iHnByP_RAxh0",
        authDomain: "surveylive-c0691.firebaseapp.com",
        projectId: "surveylive-c0691",
        storageBucket: "surveylive-c0691.firebasestorage.app",
        messagingSenderId: "894041077720",
        appId: "1:894041077720:web:2115a27b69e8b81ab724ad",
        measurementId: "G-83GZWBY7K5",
      };
      const app = initializeApp(cfg);
      db = getFirestore(app);
      Object.assign(window, { collection, addDoc, getDocs, query, orderBy });
    } catch {
      console.warn("Firebase init gagal; pakai lokal saja.");
    }

    // ===== AI Fallback Helpers =====
    function guessDailyCalorie(a) {
      let low = 1800, high = 2200;
      if (/sering|tiap|setiap|hampir/.test((a[1]||"").toLowerCase())) { low = 1700; high = 2100; }
      if (/sering|ya/.test((a[4]||"").toLowerCase()))             { low += 50; high += 100; }
      if (/ya|sudah/.test((a[8]||"").toLowerCase()))             { low += 50; high += 50; }
      low  = Math.max(1600, Math.min(low, 2200));
      high = Math.max(low + 200, Math.min(high, 2400));
      return [low, high];
    }
    function splitMeals(l, h) {
      const p = { b:0.25, l:0.35, d:0.30, s:0.10 }, r = Math.round;
      return {
        low:  { b:r(l*p.b), l:r(l*p.l), d:r(l*p.d), s:r(l*p.s) },
        high: { b:r(h*p.b), l:r(h*p.l), d:r(h*p.d), s:r(h*p.s) }
      };
    }
    function sampleMenus() {
      return [
        { name:"Sarapan: Oatmeal + pisang + susu rendah lemak", kcal:350 },
        { name:"Makan siang: Nasi merah + ayam panggang + tumis buncis", kcal:600 },
        { name:"Makan malam: Gado-gado tanpa kerupuk + telur rebus", kcal:500 },
        { name:"Snack: Yogurt tawar + buah potong / kacang panggang", kcal:150 }
      ];
    }
    function localFallbackCalorieBlock(a) {
      const [low, high] = guessDailyCalorie(a);
      const m = splitMeals(low, high);
      const menus = sampleMenus();
      return `
        <h3>AI Overview (Offline Fallback)</h3>
        <p>Rekomendasi kalori harian untuk hidup sehat: <strong>${low}â€“${high} kkal/hari</strong></p>
        <table border="1" cellpadding="4">
          <tr><th>Makan</th><th>Low</th><th>High</th></tr>
          <tr><td>Sarapan</td><td>${m.low.b}</td><td>${m.high.b}</td></tr>
          <tr><td>Siang</td><td>${m.low.l}</td><td>${m.high.l}</td></tr>
          <tr><td>Malam</td><td>${m.low.d}</td><td>${m.high.d}</td></tr>
          <tr><td>Snack</td><td>${m.low.s}</td><td>${m.high.s}</td></tr>
        </table>
        <h4>Contoh Menu</h4>
        <ul>${menus.map(x=>`<li>${x.name} (${x.kcal} kkal)</li>`).join("")}</ul>
      `;
    }

    // ===== Submit & AI Overview =====
    D.form.addEventListener("submit", async e => {
      e.preventDefault();
      const fld = document.getElementById("answer");
      if (fld && fld.value.trim()) S.tempAnswers[S.currentQuestion] = fld.value.trim();

      const answers = [...S.tempAnswers];
      const email = D.emailInput.value.trim();
      if (!email || answers.length < questions.length || answers.some(v=>!v)) {
        return alert("Pastikan email & semua jawaban terisi.");
      }

      const entry = { email, answers, time: new Date().toISOString() };
      S.allAnswers.push(entry);
      localStorage.setItem("responses", JSON.stringify(S.allAnswers));
      if (db && window.addDoc) {
        try { await addDoc(collection(db,"responses"), entry); }
        catch { console.warn("Gagal simpan Firebase."); }
      }

      D.form.style.display = "none";
      D.thankYouMessage.style.display = "block";

      // show loading sign
      D.aiOverview.innerHTML = `<p style="color:#22753e; font-style:italic;">
        AI sedang membuat ringkasan dan rekomendasi kalori...</p>`;
      D.aiOverview.style.display = "block";

      // live Gemini call
      try {
        const prompt = `Ringkas jawaban berikut (10 poin) dan berikan rekomendasi kebutuhan kalori harian untuk pola hidup sehat secara singkat:\n\n` +
          answers.map((a,i)=>`${i+1}. ${a}`).join("\n");
        const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyDIVFI3M-283v1Ume5ivh3iHnByP_RAxh0";
        const resp = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }] })
        });
        if (!resp.ok) throw new Error("API error");
        const data = await resp.json();
        const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        if (!aiText) throw new Error("Empty response");

        D.aiOverview.innerHTML = 
          `<div style="font-size:0.9em; color:#22753e; margin-bottom:6px;">AI: Gemini (live)</div>` +
          `<h3>AI Overview</h3><p>${aiText.replace(/\n/g,"<br>")}</p>`;
      } catch (err) {
        console.warn("AI gagal, pakai fallback:", err);
        D.aiOverview.innerHTML =
          `<div style="font-size:0.9em; color:#22753e; margin-bottom:6px;">AI: Offline fallback</div>` +
          localFallbackCalorieBlock(answers);
      }
    });

    // ===== View All Answers =====
    D.showAnswersBtn.addEventListener("click", async () => {
      const pass = prompt("Masukkan password untuk melihat semua jawaban:");
      if (pass !== "rahasia123") return alert("Password salah.");
      let rows = [...S.allAnswers];
      if (db && window.getDocs) {
        try {
          const snap = await getDocs(query(collection(db,"responses"), orderBy("time","desc")));
          rows = snap.docs.map(d=>d.data());
        } catch {
          console.warn("Gagal ambil Firebase; pakai lokal.");
        }
      }
      if (!rows.length) return alert("Belum ada jawaban.");

      let html = `<table><tr><th>Email</th>${questions.map(q=>`<th>${q}</th>`).join("")}<th>Waktu</th></tr>`;
      rows.forEach(r => {
        html += `<tr><td>${r.email}</td>${r.answers.map(a=>`<td>${a}</td>`).join("")}<td>${r.time}</td></tr>`;
      });
      html += `</table>`;
      D.answersContainer.innerHTML = html;
      D.answersContainer.style.display = "block";
    });
  </script>
</body>
</html>
