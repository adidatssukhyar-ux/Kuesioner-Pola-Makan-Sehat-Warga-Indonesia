<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <!-- ML5.js for in-browser image classification -->
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.6.0/dist/ml5.min.js"></script>
  <!-- Chart.js for pie charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Pola Makan Sehat Orang Indonesia</h1>

    <form id="wizardForm" autocomplete="off">
      <label for="email">Email kamu:</label>
      <input type="email" id="email" placeholder="nama@contoh.com" required />

      <div id="questionContainer"></div>

      <button type="button" id="nextBtn">Next</button>
      <button type="button" id="showAnswersBtn">ðŸ“‹ Lihat Semua Jawaban</button>
      <button type="button" id="clearLocalBtn">ðŸ—‘ Hapus Jawaban Lokal</button>
      <button type="submit" id="submitBtn" style="display:none;">Kirim</button>
    </form>

    <div id="thankYouMessage" style="display:none; margin-top:20px; text-align:center;">
      terimakasih telah menjawab survei ini
    </div>

    <div id="aiOverview" style="display:none; margin-top:20px;"></div>

    <div id="photoSection" style="display:none; margin-top:20px;">
      <h2>Upload atau Masukkan URL Foto Makanan</h2>
      <input type="url" id="imageUrl" placeholder="Tempel URL gambar (opsional)" />
      <input type="file" id="foodPhoto" accept="image/*" />
      <button type="button" id="photoSubmit">Analisis Foto</button>

      <img id="foodPreview" style="max-width:100%; margin-top:16px;" />

      <div id="photoAnalysis" style="margin-top:16px;"></div>
      <canvas id="macroChart" style="max-width:100%; margin-top:20px;"></canvas>
    </div>

    <div id="answersContainer" style="display:none; margin-top:20px; overflow:auto;"></div>
  </div>

  <script>
    // === Konstanta & State ===
    const API_KEY = "AIzaSyDIVFI3M-283v1Ume5ivh3iHnByP_RAxh0";

    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi makanan junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur sayuran?",
      "6. Sebutkan makanan yang bergizi dan tidak bergizi",
      "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
      "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
      "9. Apakah kamu hari ini sudah sarapan?",
      "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
    ];

    const S = {
      currentQuestion: 0,
      tempAnswers:    [],
      allAnswers:     JSON.parse(localStorage.getItem("responses") || "[]"),
    };

    // === DOM Refs ===
    const D = {
      emailInput:        document.getElementById("email"),
      questionContainer: document.getElementById("questionContainer"),
      nextBtn:           document.getElementById("nextBtn"),
      submitBtn:         document.getElementById("submitBtn"),
      form:              document.getElementById("wizardForm"),
      thankYouMessage:   document.getElementById("thankYouMessage"),
      aiOverview:        document.getElementById("aiOverview"),
      photoSection:      document.getElementById("photoSection"),
      imageUrl:          document.getElementById("imageUrl"),
      foodPhoto:         document.getElementById("foodPhoto"),
      photoSubmit:       document.getElementById("photoSubmit"),
      foodPreview:       document.getElementById("foodPreview"),
      photoAnalysis:     document.getElementById("photoAnalysis"),
      macroChart:        document.getElementById("macroChart"),
      showAnswersBtn:    document.getElementById("showAnswersBtn"),
      clearLocalBtn:     document.getElementById("clearLocalBtn"),
      answersContainer:  document.getElementById("answersContainer"),
    };

    // === Wizard Questions ===
    function showQuestion(idx) {
      D.questionContainer.innerHTML = `
        <label for="answer">${questions[idx] || ""}</label>
        <textarea id="answer" placeholder="Jawaban kamu..."></textarea>
      `;
      if (idx >= questions.length - 1) {
        D.nextBtn.style.display   = "none";
        D.submitBtn.style.display = "block";
      } else {
        D.nextBtn.style.display   = "block";
        D.submitBtn.style.display = "none";
      }
    }
    document.addEventListener("DOMContentLoaded", () => showQuestion(S.currentQuestion));
    D.nextBtn.addEventListener("click", () => {
      const val = document.getElementById("answer").value.trim();
      if (!D.emailInput.value.trim() || !val) return;
      S.tempAnswers[S.currentQuestion] = val;
      S.currentQuestion++;
      showQuestion(S.currentQuestion);
    });

    // === Clear LocalStorage ===
    D.clearLocalBtn.addEventListener("click", () => {
      const pass = prompt("Masukkan passcode untuk menghapus jawaban lokal:");
      if (pass !== "password") return alert("Passcode salah.");
      if (confirm("Hapus semua jawaban yang tersimpan?")) {
        localStorage.removeItem("responses");
        location.reload();
      }
    });

    // === Submit Survey & AI Overview ===
    D.form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fld = document.getElementById("answer");
      if (fld && fld.value.trim()) {
        S.tempAnswers[S.currentQuestion] = fld.value.trim();
      }
      const answers = [...S.tempAnswers];
      const email   = D.emailInput.value.trim();
      if (!email || answers.length < questions.length) {
        return alert("Pastikan email & semua jawaban terisi.");
      }

      // simpan lokal
      S.allAnswers.push({ email, answers, time: new Date().toISOString() });
      localStorage.setItem("responses", JSON.stringify(S.allAnswers));

      // UI switch
      D.form.style.display            = "none";
      D.thankYouMessage.style.display = "block";

      // loading sign
      D.aiOverview.innerHTML = `<p style="font-style:italic; text-align:center;">
        AI sedang membuat ringkasan dan rekomendasi kalori...</p>`;
      D.aiOverview.style.display = "block";

      // panggil Gemini
      try {
        const prompt = 
          `Ringkas jawaban berikut (10 poin) dan berikan rekomendasi kalori harian untuk hidup sehat:\n\n` +
          answers.map((a,i) => `${i+1}. ${a}`).join("\n");
        const resp = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`,
          {
            method: "POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }] })
          }
        );
        if (!resp.ok) throw new Error("Gemini API error");
        const data = await resp.json();
        const aiText = data.candidates[0].content.parts[0].text;
        D.aiOverview.innerHTML =
          `<h3>AI Overview</h3><p>${aiText.replace(/\n/g,"<br>")}</p>`;
      } catch {
        D.aiOverview.innerHTML =
          `<p style="color:#d00; text-align:center;">AI gagal membuat overview.</p>`;
      }

      // tampilkan photoSection
      D.photoSection.style.display = "block";
    });

    // === Macro Database & Photo Analysis ===
    const macroDB = {
      banana:     { protein:1.3,  carbohydrates:22.8, fats:0.3,  analysis:"Pisang kaya kalium dan serat." },
      pizza:      { protein:12,   carbohydrates:33,   fats:10,   analysis:"Pizza sering tinggi lemak jenuh." },
      sandwich:   { protein:15,   carbohydrates:30,   fats:8,    analysis:"Sandwich mengandung karbohidrat dan protein." },
      salad:      { protein:2,    carbohydrates:5,    fats:0.2,  analysis:"Salad rendah kalori, tinggi serat." },
      // Tambahkan mapping lainnya jika perluâ€¦
    };

    D.photoSubmit.addEventListener("click", handlePhoto);

    async function handlePhoto() {
      // 1) Tentukan sumber: URL vs file
      const urlVal = D.imageUrl.value.trim();
      let imgSrc;
      if (urlVal) {
        imgSrc = urlVal;
      } else {
        const file = D.foodPhoto.files[0];
        if (!file) return alert("Pilih foto makanan atau masukkan URL.");
        imgSrc = URL.createObjectURL(file);
      }
      D.foodPreview.src = imgSrc;

      // 2) Tampilkan loading
      D.photoAnalysis.innerHTML = `<p style="font-style:italic; text-align:center;">
        AI sedang menganalisis foto (offline)...</p>`;

      // 3) Klasifikasi via MobileNet
      try {
        const classifier = await ml5.imageClassifier('MobileNet');
        const results    = await classifier.classify(D.foodPreview);
        const label      = results[0].label.split(',')[0].toLowerCase();

        // 4) Lookup makro
        const info = macroDB[label] || {
          protein:5, carbohydrates:20, fats:5,
          analysis: `Tidak ada data makro untuk "${label}", menggunakan asumsi standar.`
        };

        const total = info.protein + info.carbohydrates + info.fats;
        const pct   = {
          protein:       Math.round(info.protein       / total * 100),
          carbohydrates: Math.round(info.carbohydrates / total * 100),
          fats:          Math.round(info.fats          / total * 100)
        };

        // 5) Tampilkan hasil
        D.photoAnalysis.innerHTML = `
          <h3>Analisis Foto</h3>
          <p>${info.analysis}</p>
          <p><strong>${label}</strong> â†’ Protein ${pct.protein}%, Karbohidrat ${pct.carbohydrates}%, Lemak ${pct.fats}%</p>
        `;

        const ctx = D.macroChart.getContext("2d");
        new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["Protein","Karbohidrat","Lemak"],
            datasets: [{
              data: [pct.protein, pct.carbohydrates, pct.fats],
              backgroundColor: ["#35a35c","#f5bc51","#e57373"]
            }]
          },
          options: { responsive:true, plugins:{ legend:{ position:"bottom" } } }
        });

      } catch (err) {
        console.error(err);
        D.photoAnalysis.innerHTML =
          `<p style="color:#d00; text-align:center;">
            Analisis foto gagal: ${err.message}
          </p>`;
      }
    }

    // === View All Answers ===
    D.showAnswersBtn.addEventListener("click", () => {
      const pass = prompt("Masukkan password untuk melihat semua jawaban:");
      if (pass !== "rahasia123") return alert("Password salah.");
      const rows = S.allAnswers;
      if (!rows.length) return alert("Belum ada jawaban.");
      let html = `<table><tr><th>Email</th>${
        questions.map(q => `<th>${q}</th>`).join("")}<th>Waktu</th></tr>`;
      rows.forEach(r => {
        html += `<tr><td>${r.email}</td>${
          r.answers.map(a => `<td>${a}</td>`).join("")}<td>${r.time}</td></tr>`;
      });
      html += `</table>`;
      D.answersContainer.innerHTML = html;
      D.answersContainer.style.display = "block";
    });
  </script>
</body>
</html>
