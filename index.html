<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="container">
  <h1>Pola Makan Sehat Orang Indonesia</h1>

  <form id="wizardForm">
    <label for="email">Email kamu:</label>
    <input type="email" name="email" id="email" required placeholder="your@email.com" />
    <div id="questionContainer" style="margin-top:12px;"></div>
    <button type="button" id="nextBtn" style="margin-top:12px;">Next</button>
    <button type="submit" id="submitBtn" style="display:none; margin-top:12px;">Kirim</button>
  </form>

  <div id="thankYouMessage" style="display:none; cursor:pointer; margin-top:12px;">
    <span>Terimakasih telah menjawab, hasil anda akan dikirim ke email dalam waktu yang singkat</span><br />
    <span id="hiddenInfo" style="display:none; color:gray;">(maybe 2 days)</span>
  </div>

  <div id="aiOverview" style="display:none; margin-top:12px; padding:14px 16px; border:1px solid #ddd; border-radius:8px; background:linear-gradient(135deg,#ffffff,#f7f7f7); box-shadow:0 2px 6px rgba(0,0,0,0.05); font-size:14px; line-height:1.5em; color:#333;"></div>

  <hr />
  <button id="showAnswersBtn" type="button">üìã Lihat Semua Jawaban</button>
  <div id="answersContainer" style="display:none; margin-top:10px;"></div>
</div>

<!-- Script 1: Always-render core (no imports, guaranteed to run) -->
<script>
  // üìù Questions (visible and easy to edit)
  const questions = [
    "1. Menurut kamu makanan junk food sehat atau tidak?",
    "2. Seberapa sering kamu mengonsumsi makanan junk food?",
    "3. Berapa kali kamu makan dalam sehari?",
    "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
    "5. Apakah kamu sering mengonsumsi sayur sayuran?",
    "6. Sebutkan makanan yang bergizi dan tidak bergizi",
    "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
    "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
    "9. Apakah kamu hari ini sudah sarapan?",
    "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
  ];

  // Global-ish state the module script can also read
  window.__surveyState = {
    currentQuestion: 0,
    tempAnswers: [],
    allAnswers: JSON.parse(localStorage.getItem("responses") || "[]"),
  };

  // DOM refs
  const emailInput = document.getElementById("email");
  const questionContainer = document.getElementById("questionContainer");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const form = document.getElementById("wizardForm");
  const thankYouMessage = document.getElementById("thankYouMessage");
  const hiddenInfo = document.getElementById("hiddenInfo");
  const aiOverview = document.getElementById("aiOverview");
  const showAnswersBtn = document.getElementById("showAnswersBtn");
  const answersContainer = document.getElementById("answersContainer");

  // Render one question
  function showQuestion(index) {
    const q = questions[index] ?? "";
    questionContainer.innerHTML = `
      <label for="answer">${q}</label>
      <textarea id="answer" placeholder="Jawaban kamu..." style="width:100%; min-height:110px; margin-top:8px;"></textarea>
    `;
    if (index >= questions.length - 1) {
      nextBtn.style.display = "none";
      submitBtn.style.display = "inline-block";
    } else {
      nextBtn.style.display = "inline-block";
      submitBtn.style.display = "none";
    }
  }

  // Initial render ‚Äî this guarantees you SEE the first question
  document.addEventListener("DOMContentLoaded", () => {
    showQuestion(window.__surveyState.currentQuestion);
  });

  // Next button: capture answer and advance
  nextBtn.addEventListener("click", () => {
    const s = window.__surveyState;
    const answerField = document.getElementById("answer");
    if (!emailInput.value.trim() || !answerField.value.trim()) return;
    s.tempAnswers[s.currentQuestion] = answerField.value.trim();
    s.currentQuestion++;
    showQuestion(s.currentQuestion);
  });

  // Thank-you playful reveal
  thankYouMessage.addEventListener("click", () => {
    hiddenInfo.style.display = "inline";
  });

  // Expose some things for the module script
  window.__surveyDOM = {
    emailInput,
    questionContainer,
    nextBtn,
    submitBtn,
    form,
    thankYouMessage,
    hiddenInfo,
    aiOverview,
    showAnswersBtn,
    answersContainer,
    showQuestion, // so the module can reuse it
    questions
  };
</script>

<!-- Script 2: Enhancements (Firebase, Gemini, viewer).
     If this fails for any reason, questions still show from Script 1. -->
<script type="module">
  // Safe-guard: if core state is missing, bail gracefully
  const S = window.__surveyState;
  const D = window.__surveyDOM;
  if (!S || !D) {
    console.warn("Core script not found. The questions should still show.");
  }

  // Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    query,
    orderBy,
  } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAGxE7jKysNL097Ip_8_Xjr7pid3XNPCZY",
    authDomain: "surveylive-c0691.firebaseapp.com",
    projectId: "surveylive-c0691",
    storageBucket: "surveylive-c0691.firebasestorage.app",
    messagingSenderId: "894041077720",
    appId: "1:894041077720:web:2115a27b69e8b81ab724ad",
    measurementId: "G-83GZWBY7K5",
  };

  let db = null;
  try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
  } catch (e) {
    console.warn("Firebase init failed. Local save will still work.", e);
  }

  // Gemini Overview
  async function generateOverview(answers = []) {
    const prompt = `
    Buat ringkasan dan saran pola makan berdasarkan jawaban berikut:
    ${answers.map((ans, i) => `${D.questions[i]}: ${ans}`).join("\n")}
    Gunakan bahasa yang ramah, jelas, dan berikan tips yang relevan.
    `;

    try {
      const res = await fetch(
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyBPcdZLEOAb7zgjtj5Tu9lzQBD1SAFayDQ",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
          }),
        }
      );
      const data = await res.json();
      const text =
        data?.candidates?.[0]?.content?.parts?.[0]?.text ||
        "Tidak ada ringkasan.";
      return `<strong>üìä Ringkasan & Saran:</strong><br>${text}`;
    } catch (err) {
      console.error(err);
      return "‚öô Ringkasan tidak tersedia saat ini, namun jawaban kamu sudah tersimpan.";
    }
  }

  // Submit handler
  D.form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const s = S;
    const answerField = document.getElementById("answer");
    if (!answerField?.value?.trim()) return;

    s.tempAnswers[s.currentQuestion] = answerField.value.trim();

    // Local save
    s.allAnswers.push({
      email: D.emailInput.value.trim(),
      answers: [...s.tempAnswers],
    });
    localStorage.setItem("responses", JSON.stringify(s.allAnswers));

    // Firebase save (best-effort)
    if (db) {
      try {
        await addDoc(collection(db, "responses"), {
          email: D.emailInput.value.trim(),
          answers: [...s.tempAnswers],
          timestamp: new Date(),
        });
      } catch (err) {
        console.error("Firebase save failed:", err);
      }
    }

    // Thank you + AI overview
    D.thankYouMessage.style.display = "block";
    D.aiOverview.innerHTML = await generateOverview(s.tempAnswers);
    D.aiOverview.style.display = "block";

    // Reset for next respondent
    D.form.reset();
    S.currentQuestion = 0;
    S.tempAnswers = [];
    D.showQuestion(S.currentQuestion);
  });

  // Viewer (password: rahasia123)
  D.showAnswersBtn.addEventListener("click", async () => {
    const pass = prompt("Masukkan password untuk melihat jawaban:");
    if (pass !== "rahasia123") {
      alert("Password salah!");
      return;
    }

    let combined = [...S.allAnswers];

    if (db) {
      try {
        const q = query(collection(db, "responses"), orderBy("timestamp"));
        const snapshot = await getDocs(q);
        snapshot.forEach((doc) => combined.push(doc.data()));
      } catch (err) {
        console.warn("Could not load from Firebase, showing local only.");
      }
    }

    if (combined.length === 0) {
      D.answersContainer.innerHTML = "<p>Belum ada jawaban yang masuk.</p>";
    } else {
      let html =
        "<table border='1' cellspacing='0' cellpadding='6'><tr><th>Email</th><th>Jawaban</th></tr>";
      combined.forEach((row) => {
        const safeEmail = (row.email ?? "").toString();
        const safeAns = Array.isArray(row.answers)
          ? row.answers.join(" | ")
          : "";
        html += `<tr><td>${safeEmail}</td><td>${safeAns}</td></tr>`;
      });
      html += "</table>";
      D.answersContainer.innerHTML = html;
    }
    D.answersContainer.style.display = "block";
  });
</script>
</body>
</html>
