<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Test Photo → Pie-Chart & Food List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.6.0/dist/ml5.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      font-family: 'Segoe UI',sans-serif;
      background: #f5fcf7; color: #333; line-height:1.4;
    }
    .container {
      max-width:800px; margin:40px auto; padding:24px;
      background:#fff; border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.05);
    }
    h2 { text-align:center; color:#2a7955; margin-bottom:16px }
    .flex { display:flex; gap:24px; flex-wrap:wrap }
    .left, .right {
      flex:1; min-width:300px; position:relative;
    }
    input, button {
      width:100%; padding:10px; margin-top:8px;
      border:1px solid #cdefe1; border-radius:8px;
      font-size:1em;
    }
    button {
      background: linear-gradient(90deg,#2a7955,#5fb58c);
      color:#fff; border:none; cursor:pointer;
    }
    button:hover {
      background: linear-gradient(90deg,#236643,#4fa27f);
    }
    #preview {
      display:none; margin:12px auto; max-height:120px;
      border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.05);
    }
    .chart-container {
      position: relative; height:200px; margin-top:12px;
    }
    .chart-container canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
    }
    #foodList {
      margin-top:8px; max-height:220px; overflow-y:auto;
      border:1px solid #cdefe1; border-radius:8px;
      background:#f0fff8;
    }
    .food-item {
      padding:8px 10px; border-bottom:1px solid #e0e0e0;
      cursor:pointer; font-size:0.95em;
    }
    .food-item:last-child { border-bottom:none }
    .food-item:hover { background:rgba(42,121,85,0.1) }
    #foodDetail {
      display:none; margin-top:8px; padding:12px;
      background:#fff; border:1px solid #cdefe1;
      border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.1);
      position:relative;
    }
    #foodDetail button {
      position:absolute; top:8px; right:8px;
      background:none; border:none; font-size:1.2em;
      cursor:pointer; color:#666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Analisis Foto & Daftar Makanan</h2>
    <div class="flex">
      <!-- LEFT: Photo + Pie Chart -->
      <div class="left">
        <input id="imageUrl" type="url" placeholder="URL foto (opsional)">
        <input id="foodPhoto" type="file" accept="image/*">
        <button id="analyze">Analisis Foto</button>
        <img id="preview" alt="Preview Gambar">
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
      </div>

      <!-- RIGHT: Searchable List + Detail -->
      <div class="right">
        <input id="foodSearch" type="text" placeholder="Cari makanan...">
        <div id="foodList"></div>
        <div id="foodDetail">
          <button id="closeDetail">&times;</button>
          <div id="detailContent"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Indonesian food DB (20+ items)
    const foods = [
      {key:"apple",name:"Apel",protein:0.3,carbs:14,fats:0.2,energy:52},
      {key:"banana",name:"Pisang",protein:1.3,carbs:23,fats:0.3,energy:96},
      {key:"nasigoreng",name:"Nasi Goreng",protein:7,carbs:50,fats:15,energy:350},
      {key:"sotoayam",name:"Soto Ayam",protein:8,carbs:10,fats:5,energy:120},
      {key:"rendang",name:"Rendang",protein:14,carbs:2,fats:30,energy:320},
      {key:"bakso",name:"Bakso",protein:6,carbs:5,fats:7,energy:120},
      {key:"miegoreng",name:"Mie Goreng",protein:8,carbs:60,fats:20,energy:400},
      {key:"pecellele",name:"Pecel Lele",protein:20,carbs:10,fats:15,energy:260},
      {key:"ayamgoreng",name:"Ayam Goreng",protein:25,carbs:0,fats:20,energy:300},
      {key:"nasipadang",name:"Nasi Padang",protein:8,carbs:45,fats:15,energy:360},
      {key:"pempek",name:"Pempek",protein:12,carbs:30,fats:5,energy:220},
      {key:"nasiuduk",name:"Nasi Uduk",protein:6,carbs:50,fats:15,energy:350},
      {key:"buburayam",name:"Bubur Ayam",protein:5,carbs:30,fats:3,energy:180},
      {key:"gadogado",name:"Gado Gado",protein:10,carbs:20,fats:10,energy:220},
      {key:"martabaktelor",name:"Martabak Telor",protein:14,carbs:10,fats:20,energy:300},
      {key:"martabakmanis",name:"Martabak Manis",protein:6,carbs:45,fats:15,energy:330},
      {key:"ketoprak",name:"Ketoprak",protein:8,carbs:30,fats:10,energy:260},
      {key:"lontongsayur",name:"Lontong Sayur",protein:4,carbs:40,fats:8,energy:260},
      {key:"sotobetawi",name:"Soto Betawi",protein:9,carbs:10,fats:20,energy:240},
      {key:"escampur",name:"Es Campur",protein:2,carbs:30,fats:5,energy:180}
    ];
    const db = Object.fromEntries(foods.map(f=>[f.key,f]));

    // Refs
    const preview     = document.getElementById("preview");
    const analyzeBtn  = document.getElementById("analyze");
    const pieCan      = document.getElementById("pieChart");
    const foodSearch  = document.getElementById("foodSearch");
    const foodList    = document.getElementById("foodList");
    const detailBox   = document.getElementById("foodDetail");
    const detailCont  = document.getElementById("detailContent");
    document.getElementById("closeDetail").onclick = () => {
      detailBox.style.display = "none";
    };

    // Build searchable list
    function buildList() {
      foodList.innerHTML = "";
      foods.forEach(f => {
        const div = document.createElement("div");
        div.className = "food-item";
        div.textContent = f.name;
        div.onclick = () => showDetail(f);
        foodList.append(div);
      });
    }
    buildList();

    foodSearch.oninput = () => {
      const q = foodSearch.value.toLowerCase();
      document.querySelectorAll(".food-item").forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
      });
      detailBox.style.display = "none";
    };

    function showDetail(f) {
      detailCont.innerHTML = `
        <h4>${f.name}</h4>
        <p>Protein: ${f.protein} g</p>
        <p>Karbo: ${f.carbs} g</p>
        <p>Lemak: ${f.fats} g</p>
        <p>Energi: ${f.energy} kcal</p>
      `;
      detailBox.style.display = "block";
    }

    // Photo analysis → Pie chart
    analyzeBtn.onclick = async () => {
      let src = document.getElementById("imageUrl").value.trim();
      const file = document.getElementById("foodPhoto").files[0];
      if (!src && file) src = URL.createObjectURL(file);
      if (!src) return alert("Masukkan URL foto atau pilih file.");

      preview.src = src;
      preview.style.display = "block";

      // classify with ml5
      const classifier = await ml5.imageClassifier("MobileNet");
      const [res] = await classifier.classify(preview);
      const key = res.label.split(",")[0].toLowerCase();
      const info = db[key] || { name:key, protein:0, carbs:0, fats:0, energy:0 };

      // compute percentages
      const total = info.protein + info.carbs + info.fats || 1;
      const data = [
        Math.round(info.protein/total * 100),
        Math.round(info.carbs/total * 100),
        Math.round(info.fats/total * 100)
      ];

      // render pie
      if (pieCan._chart) pieCan._chart.destroy();
      pieCan._chart = new Chart(pieCan.getContext("2d"), {
        type: "pie",
        data: {
          labels: ["Protein", "Karbo", "Lemak"],
          datasets: [{ data, backgroundColor:["#2a7955","#5fb58c","#e57373"] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend:{ position:"bottom" } }
        }
      });
    };
  });
  </script>
</body>
</html>
