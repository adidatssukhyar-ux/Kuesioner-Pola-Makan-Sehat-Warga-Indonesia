<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>Pola Makan Sehat Orang Indonesia</h1>

    <form id="wizardForm" autocomplete="off">
      <label for="email">Email kamu:</label>
      <input type="email" name="email" id="email" required placeholder="nama@contoh.com" />

      <div id="questionContainer"></div>

      <div class="button-group">
        <button type="button" id="nextBtn">Next</button>
        <button type="button" id="showAnswersBtn">ðŸ“‹ Lihat Semua Jawaban</button>
        <button type="button" id="clearLocalBtn">ðŸ—‘ Hapus Jawaban Lokal</button>
      </div>

      <button type="submit" id="submitBtn" style="display:none;">Kirim</button>
    </form>

    <div id="thankYouMessage" style="display:none; cursor:pointer;">
      Terimakasih telah menjawab, hasil anda akan dikirim ke email dalam waktu yang singkat
      <span id="hiddenInfo" class="final-message" style="display:none;">(maybe 2 days)</span>
    </div>

    <div id="aiOverview" style="display:none; margin-top:16px;"></div>

    <div id="answersContainer" style="display:none; margin-top:16px; overflow:auto;"></div>
  </div>

  <script type="module">
    // =========================
    // Data & State
    // =========================
    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi makanan junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur sayuran?",
      "6. Sebutkan makanan yang bergizi dan tidak bergizi",
      "7. Menurut kamu makanan bergizi penting atau tidak bagi manusia?",
      "8. Sayur sayuran dan buah buahan apakah termasuk makanan bergizi?",
      "9. Apakah kamu hari ini sudah sarapan?",
      "10. Mengapa kebanyakan orang lebih suka mengonsumsi makanan junk food atau yang mengandung banyak minyak seperti gorengan?"
    ];

    const S = {
      currentQuestion: 0,
      tempAnswers: [],
      allAnswers: JSON.parse(localStorage.getItem("responses") || "[]"),
    };

    // =========================
    // DOM
    // =========================
    const D = {
      emailInput: document.getElementById("email"),
      questionContainer: document.getElementById("questionContainer"),
      nextBtn: document.getElementById("nextBtn"),
      submitBtn: document.getElementById("submitBtn"),
      form: document.getElementById("wizardForm"),
      thankYouMessage: document.getElementById("thankYouMessage"),
      hiddenInfo: document.getElementById("hiddenInfo"),
      aiOverview: document.getElementById("aiOverview"),
      showAnswersBtn: document.getElementById("showAnswersBtn"),
      clearLocalBtn: document.getElementById("clearLocalBtn"),
      answersContainer: document.getElementById("answersContainer"),
    };

    // =========================
    // UI Flow
    // =========================
    function showQuestion(index) {
      const q = questions[index] ?? "";
      D.questionContainer.innerHTML = `
        <label for="answer">${q}</label>
        <textarea id="answer" placeholder="Jawaban kamu..."></textarea>
      `;
      if (index >= questions.length - 1) {
        D.nextBtn.style.display = "none";
        D.submitBtn.style.display = "inline-block";
      } else {
        D.nextBtn.style.display = "inline-block";
        D.submitBtn.style.display = "none";
      }
    }

    document.addEventListener("DOMContentLoaded", () => showQuestion(S.currentQuestion));

    D.nextBtn.addEventListener("click", () => {
      const answerField = document.getElementById("answer");
      if (!D.emailInput.value.trim() || !answerField.value.trim()) {
        alert("Isi email dan jawaban terlebih dahulu.");
        return;
      }
      S.tempAnswers[S.currentQuestion] = answerField.value.trim();
      S.currentQuestion++;
      showQuestion(S.currentQuestion);
    });

    D.thankYouMessage.addEventListener("click", () => {
      D.hiddenInfo.style.display = "inline";
    });

    // =========================
    // Delete Local with passcode
    // =========================
    D.clearLocalBtn.addEventListener("click", () => {
      const pass = prompt("Masukkan passcode untuk menghapus jawaban lokal:");
      if (pass !== "password") {
        alert("Passcode salah. Jawaban lokal tidak dihapus.");
        return;
      }
      if (confirm("Hapus semua jawaban yang tersimpan di browser ini?")) {
        localStorage.removeItem("responses");
        alert("Jawaban lokal dihapus.");
        location.reload();
      }
    });

    // =========================
    // Firebase (optional)
    // =========================
    let db = null;
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js");
      const { getFirestore, collection, addDoc, getDocs, query, orderBy } = await import("https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js");
      const firebaseConfig = {
        apiKey: "AIzaSyAGxE7jKysNL097Ip_8_Xjr7pid3XNPCZY",
        authDomain: "surveylive-c0691.firebaseapp.com",
        projectId: "surveylive-c0691",
        storageBucket: "surveylive-c0691.firebasestorage.app",
        messagingSenderId: "894041077720",
        appId: "1:894041077720:web:2115a27b69e8b81ab724ad",
        measurementId: "G-83GZWBY7K5",
      };
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      Object.assign(window, { collection, addDoc, getDocs, query, orderBy });
    } catch (e) {
      console.warn("Firebase init gagal. Lanjutkan dengan penyimpanan lokal saja.");
    }

    // =========================
    // AI Fallback Helpers
    // =========================
    function guessDailyCalorie(answers) {
      const freqJunk = (answers[1] || "").toLowerCase();
      const vegOften = (answers[4] || "").toLowerCase();
      const breakfast = (answers[8] || "").toLowerCase();
      let low = 1800, high = 2200;
      if (/sering|tiap|setiap|hampir/.test(freqJunk)) { low = 1700; high = 2100; }
      if (/sering|ya|tiap|setiap/.test(vegOften)) { low += 50; high += 100; }
      if (/ya|sudah/.test(breakfast)) { low += 50; high += 50; }
      low = Math.max(1600, Math.min(low, 2200));
      high = Math.max(low + 200, Math.min(high, 2400));
      return [low, high];
    }

    function splitMeals(totalLow, totalHigh) {
      const pct = { b: 0.25, l: 0.35, d: 0.30, s: 0.10 };
      const r = x => Math.round(x);
      return {
        low:  { b: r(totalLow  * pct.b), l: r(totalLow  * pct.l), d: r(totalLow  * pct.d), s: r(totalLow  * pct.s) },
        high: { b: r(totalHigh * pct.b), l: r(totalHigh * pct.l), d: r(totalHigh * pct.d), s: r(totalHigh * pct.s) }
      };
    }

    function sampleMenus() {
      return [
        { name: "Sarapan: Oatmeal + pisang + susu rendah lemak", kcal: 350 },
        { name: "Makan siang: Nasi merah 150g + ayam panggang 120g + tumis buncis", kcal: 600 },
        { name: "Makan malam: Gado-gado tanpa kerupuk + telur rebus", kcal: 500 },
        { name: "Snack: Yogurt tawar + buah potong / kacang panggang", kcal: 150 }
      ];
    }

    function localFallbackCalorieBlock(answers) {
      const [low, high] = guessDailyCalorie(answers);
      const m = splitMeals(low, high);
      const menus = sampleMenus();
      return `
        <h3 style="color:#22753e;">AI Overview (Offline Fallback)</h3>
        <p style="color:#22753e;">Perkiraan kebutuhan: ${low}â€“${high} kkal/hari</p>
        <table style="width:100%; border-collapse:collapse; background:#fff;">
          <tr style="background:#f7f7f7;"><th style="border:1px solid #ddd; padding:6px;">Makan</th><th style="border:1px solid #ddd; padding:6px;">Low</th><th style="border:1px solid #ddd; padding:6px;">High</th></tr>
          <tr><td style="border:1px solid #ddd; padding:6px;">Sarapan</td><td style="border:1px solid #ddd; padding:6px;">${m.low.b}</td><td style="border:1px solid #ddd; padding:6px;">${m.high.b}</td></tr>
          <tr><td style="border:1px solid #ddd; padding:6px;">Siang</td><td style="border:1px solid #ddd; padding:6px;">${m.low.l}</td><td style="border:1px solid #ddd; padding:6px;">${m.high.l}</td></tr>
          <tr><td style="border:1px solid #ddd; padding:6px;">Malam</td><td style="border:1px solid #ddd; padding:6px;">${m.low.d}</td><td style="border:1px solid #ddd; padding:6px;">${m.high.d}</td></tr>
          <tr><td style="border:1px solid #ddd; padding:6px;">Snack</td><td style="border:1px solid #ddd; padding:6px;">${m.low.s}</td><td style="border:1px solid #ddd; padding:6px;">${m.high.s}</td></tr>
        </table>
        <h4 style="color:#22753e;">Contoh Menu</h4>
        <ul style="color:#22753e; padding-left:18px;">${menus.map(x => `<li>${x.name} (${x.kcal} kkal)</li>`).join("")}</ul>
      `;
    }

    // =========================
    // Submit: save + AI + thanks
    // =========================
    D.form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Capture the current textarea value in case user submits on the last step
      const currentField = document.getElementById("answer");
      if (currentField && currentField.value.trim()) {
        S.tempAnswers[S.currentQuestion] = currentField.value.trim();
      }

      const answers = [...S.tempAnswers];
      const email = D.emailInput.value.trim();
      if (!email || answers.length < questions.length || answers.some(a => !a || !a.trim())) {
        alert("Pastikan email dan semua jawaban terisi.");
        return;
      }

      const entry = { email, answers, time: new Date().toISOString() };

      // Save local
      S.allAnswers.push(entry);
      localStorage.setItem("responses", JSON.stringify(S.allAnswers));

      // Save Firebase
      if (db && window.addDoc) {
        try {
          await window.addDoc(window.collection(db, "responses"), entry);
        } catch (err) {
          console.warn("Gagal simpan ke Firebase:", err);
        }
      }

      // UI switch
      D.form.style.display = "none";
      D.thankYouMessage.style.display = "block";

      // AI overview (Gemini) with fallback
      try {
        const prompt = `Ringkas jawaban berikut (10 poin) dan berikan saran pola makan sehat singkat:\n\n${answers.map((a,i)=>`${i+1}. ${a}`).join("\n")}`;
        const resp = await fetch("https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=AIzaSyBPcdZLEOAb7zgjtj5Tu9lzQBD1SAFayDQ", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        if (!resp.ok) throw new Error("Gemini API error");
        const data = await resp.json();
        const aiText = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
        if (!aiText) throw new Error("Empty AI text");
        D.aiOverview.innerHTML = `<h3 style="color:#22753e;">AI Overview</h3><p style="color:#22753e;">${aiText.replace(/\n/g,"<br>")}</p>`;
      } catch (err) {
        console.warn("AI gagal, pakai fallback:", err);
        D.aiOverview.innerHTML = localFallbackCalorieBlock(answers);
      }
      D.aiOverview.style.display = "block";
    });

    // =========================
    // Viewer (password: rahasia123)
    // =========================
    D.showAnswersBtn.addEventListener("click", async () => {
      const pass = prompt("Masukkan password untuk melihat semua jawaban:");
      if (pass !== "rahasia123") {
        alert("Password salah.");
        return;
      }
      let rows = [...S.allAnswers];
      if (db && window.getDocs) {
        try {
          const snap = await window.getDocs(
            window.query(window.collection(db, "responses"), window.orderBy("time","desc"))
          );
          rows = snap.docs.map(d => d.data());
        } catch (e) {
          console.warn("Gagal ambil dari Firebase, pakai lokal:", e);
        }
      }
      if (!rows.length) {
        alert("Belum ada jawaban tersimpan.");
        return;
      }
      let html = `<div style="overflow:auto;"><table style="border-collapse:collapse; width:100%; background:#fff; color:#111;">
        <tr style="background:#f7f7f7;">
          <th style="border:1px solid #ddd; padding:6px;">Email</th>
          ${questions.map(q=>`<th style="border:1px solid #ddd; padding:6px;">${q}</th>`).join("")}
          <th style="border:1px solid #ddd; padding:6px;">Waktu</th>
        </tr>`;
      rows.forEach(r => {
        html += `<tr>
          <td style="border:1px solid #ddd; padding:6px;">${r.email}</td>
          ${(r.answers||[]).map(a=>`<td style="border:1px solid #ddd; padding:6px;">${a}</td>`).join("")}
          <td style="border:1px solid #ddd; padding:6px;">${r.time||""}</td>
        </tr>`;
      });
      html += `</table></div>`;
      D.answersContainer.innerHTML = html;
      D.answersContainer.style.display = "block";
    });
  </script>
</body>
</html>
```
