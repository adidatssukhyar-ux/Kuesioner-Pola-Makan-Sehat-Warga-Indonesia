<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pola Makan Sehat Orang Indonesia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Your OG stylesheet -->
  <link rel="stylesheet" href="style.css" />

  <!-- ML5.js for in-browser classification -->
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.6.0/dist/ml5.min.js"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Inline helpers; main look in style.css -->
  <style>
    .hidden { display: none; }
    .flex { display: flex; gap: 24px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 260px; display: flex; flex-direction: column; }
    .preview { max-width: 200px; margin: 16px auto; border-radius: 8px; }
    .food-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 8px; background: #fafafa; }
    .food-item { display: flex; align-items: center; padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; }
    .food-item:last-child { border-bottom: none; }
    .food-item img { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 12px; }
    .food-item:hover { background: #f0f0f0; }
    .food-detail img { max-width: 150px; margin: 12px auto; border-radius: 8px; display: block; }
    .small-btn { background: #f5f5f5; color: #333; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; font-size: 0.9em; cursor: pointer; margin-right: 8px; }
    .small-btn:hover { background: #eaeaea; }
    .button-group { margin-top: 12px; }
    #questionContainer label { font-weight: 600; display: block; margin-top: 12px; }
    #questionContainer textarea { width: 100%; height: 80px; margin-top: 4px; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pola Makan Sehat Orang Indonesia</h1>

    <!-- Survey Section -->
    <section id="surveySection">
      <form id="surveyForm" autocomplete="off">
        <label for="email">Email kamu:</label>
        <input type="email" id="email" placeholder="nama@contoh.com" required />

        <div id="questionContainer"></div>

        <div class="button-group">
          <button type="button" id="viewAnswersBtn" class="small-btn">Lihat Jawaban</button>
          <button type="button" id="deleteLastBtn" class="small-btn">Hapus Jawaban Terakhir</button>
          <button type="button" id="nextBtn">Next</button>
          <button type="submit" id="submitBtn" class="hidden">Kirim</button>
        </div>
      </form>
    </section>

    <!-- Results Section -->
    <section id="resultsSection" class="hidden">
      <div class="flex">
        <!-- Photo Analysis Column -->
        <div class="col">
          <h2>Analisis Foto</h2>
          <div class="flex photo-controls">
            <input type="url" id="imageUrl" placeholder="URL foto (opsional)" />
            <input type="file" id="foodPhoto" accept="image/*" />
            <button id="photoSubmit">Analisis</button>
          </div>
          <img id="foodPreview" class="preview hidden" alt="Preview makanan" />
          <div id="photoAnalysis"></div>
          <canvas id="macroPie"></canvas>
          <canvas id="macroDiff"></canvas>
          <div id="geminiOverview"></div>
        </div>

        <!-- Food Database Column -->
        <div class="col">
          <h2>Basis Data Makanan</h2>
          <input type="text" id="foodSearch" placeholder="Cari makanan..." />
          <div id="foodList" class="food-list"></div>
          <div id="foodDetail" class="food-detail"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- Survey Wizard Setup ---
    console.log("⚙️ Wizard init");
    const questions = [
      "1. Menurut kamu makanan junk food sehat atau tidak?",
      "2. Seberapa sering kamu mengonsumsi junk food?",
      "3. Berapa kali kamu makan dalam sehari?",
      "4. Apakah kamu sering mengonsumsi soda/minuman berwarna?",
      "5. Apakah kamu sering mengonsumsi sayur-sayuran?",
      "6. Sebutkan makanan yang bergizi dan tidak bergizi.",
      "7. Menurut kamu makanan bergizi penting atau tidak?",
      "8. Buah & sayur termasuk makanan bergizi?",
      "9. Apakah kamu hari ini sudah sarapan?",
      "10. Mengapa orang suka junk food?"
    ];
    let idx = 0;
    let answers = [];

    // Macro Database
    const macroDBList = [
      { key:"apple",   name:"Apel",         protein:0.3, carbs:14,   fats:0.2, energy:52,  img:"https://upload.wikimedia.org/wikipedia/commons/1/15/Red_Apple.jpg" },
      { key:"banana",  name:"Pisang",       protein:1.3, carbs:23,   fats:0.3, energy:96,  img:"https://upload.wikimedia.org/wikipedia/commons/8/8a/Banana-Single.jpg" },
      { key:"rice",    name:"Nasi Putih",   protein:2.7, carbs:28,   fats:0.3, energy:130, img:"https://upload.wikimedia.org/wikipedia/commons/6/60/Cooked_rice.jpg" },
      { key:"chicken", name:"Ayam Panggang",protein:27,  carbs:0,    fats:3.6, energy:165, img:"https://upload.wikimedia.org/wikipedia/commons/3/35/Grilled_chicken.jpg" },
      { key:"pizza",   name:"Pizza",        protein:12,  carbs:33,   fats:10,  energy:266, img:"https://upload.wikimedia.org/wikipedia/commons/d/d3/Supreme_pizza.jpg" },
      { key:"salad",   name:"Salad",        protein:2,   carbs:5,    fats:0.2, energy:35,  img:"https://upload.wikimedia.org/wikipedia/commons/3/38/Gr%C3%BCner_Salat.jpg" },
      { key:"egg",     name:"Telur Rebus",  protein:6,   carbs:0.6,  fats:5.3, energy:78,  img:"https://upload.wikimedia.org/wikipedia/commons/9/94/Hardboiled_egg.jpg" },
      { key:"noodles", name:"Mie",          protein:4.5, carbs:35,   fats:2.9, energy:138, img:"https://upload.wikimedia.org/wikipedia/commons/3/3a/Ramen_in_Japan.jpg" }
    ];
    const macroDB = Object.fromEntries(
      macroDBList.map(o => [o.key, {
        protein: o.protein,
        carbs: o.carbs,
        fats: o.fats,
        energy: o.energy,
        analysis: `${o.name} mengandung ${o.protein}g protein, ${o.carbs}g karbo, ${o.fats}g lemak, dan ${o.energy} kcal per sajian.`
      }]])
    );

    // DOM refs
    const Qc       = document.getElementById("questionContainer");
    const nextBtn  = document.getElementById("nextBtn");
    const submitBtn= document.getElementById("submitBtn");
    const viewBtn  = document.getElementById("viewAnswersBtn");
    const delBtn   = document.getElementById("deleteLastBtn");
    const form     = document.getElementById("surveyForm");
    const emailIn  = document.getElementById("email");
    const surveySection  = document.getElementById("surveySection");
    const resultsSection = document.getElementById("resultsSection");
    const foodList = document.getElementById("foodList");
    const foodSearch = document.getElementById("foodSearch");
    const foodDetail = document.getElementById("foodDetail");

    function showQuestion(i) {
      console.log("Showing question", i);
      Qc.innerHTML = `
        <label>${questions[i]}</label>
        <textarea id="answer" placeholder="Jawaban kamu..."></textarea>
      `;
      if (i === questions.length - 1) {
        nextBtn.classList.add("hidden");
        submitBtn.classList.remove("hidden");
      } else {
        nextBtn.classList.remove("hidden");
        submitBtn.classList.add("hidden");
      }
    }
    showQuestion(0);

    nextBtn.addEventListener("click", () => {
      const val = document.getElementById("answer").value.trim();
      if (!val) return alert("Isi jawaban dulu.");
      answers.push(val);
      idx++;
      showQuestion(idx);
    });

    viewBtn.addEventListener("click", () => {
      if (!answers.length) return alert("Belum ada jawaban.");
      const list = answers.map((v,i) => `${i+1}. ${questions[i]}\nJawaban: ${v}`).join("\n\n");
      alert("Ringkasan Jawaban:\n\n" + list);
    });

    delBtn.addEventListener("click", () => {
      if (!answers.length) return alert("Belum ada jawaban utk dihapus.");
      answers.pop();
      idx = Math.max(0, idx - 1);
      showQuestion(idx);
      alert(`Jawaban ke-${idx+1} dihapus. Silakan ulang.`);
    });

    form.addEventListener("submit", e => {
      e.preventDefault();
      const last = document.getElementById("answer").value.trim();
      if (last) answers.push(last);
      if (!emailIn.value.trim() || answers.length < questions.length) {
        return alert("Isi email & semua jawaban dulu.");
      }
      surveySection.classList.add("hidden");
      resultsSection.classList.remove("hidden");
      buildFoodList();
    });

    // Build and filter food list
    function buildFoodList() {
      foodList.innerHTML = "";
      macroDBList.forEach(item => {
        const div = document.createElement("div");
        div.className = "food-item";
        div.innerHTML = `<img src="${item.img}" alt="${item.name}" /><span>${item.name}</span>`;
        div.onclick = () => showFoodDetail(item);
        foodList.append(div);
      });
    }
    foodSearch.addEventListener("input", () => {
      const q = foodSearch.value.trim().toLowerCase();
      document.querySelectorAll(".food-item").forEach(el => {
        el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
      });
    });
    function showFoodDetail(item) {
      foodDetail.innerHTML = `
        <h3>${item.name}</h3>
        <img src="${item.img}" alt="${item.name}" />
        <canvas id="detailChart"></canvas>`;
      const ctx = document.getElementById("detailChart").getContext("2d");
      new Chart(ctx, {
        type:"bar",
        data:{
          labels:["Protein (g)","Karbo (g)","Lemak (g)","Energi (kcal)"],
          datasets:[{
            label: item.name,
            data: [item.protein,item.carbs,item.fats,item.energy],
            backgroundColor:["#35a35c","#f5bc51","#e57373","#5c97f5"]
          }]
        },
        options:{ responsive:true, plugins:{ legend:{ display:false }}}
      });
    }

    // Photo Analysis & Charts & Gemini
    const imageUrl     = document.getElementById("imageUrl");
    const foodPhoto    = document.getElementById("foodPhoto");
    const photoSubmit  = document.getElementById("photoSubmit");
    const foodPreview  = document.getElementById("foodPreview");
    const photoAnalysis= document.getElementById("photoAnalysis");
    const macroPie     = document.getElementById("macroPie");
    const macroDiff    = document.getElementById("macroDiff");
    const geminiOverview = document.getElementById("geminiOverview");

    photoSubmit.addEventListener("click", async () => {
      let src = imageUrl.value.trim();
      if (!src) {
        const f = foodPhoto.files[0];
        if (!f) return alert("Pilih file atau masukkan URL.");
        src = URL.createObjectURL(f);
      }
      foodPreview.src = src;
      foodPreview.classList.remove("hidden");
      photoAnalysis.innerHTML = `<p style="font-style:italic;">Menganalisis foto…</p>`;
      clearChart(macroPie);
      clearChart(macroDiff);
      geminiOverview.innerHTML = "";

      const classifier = await ml5.imageClassifier("MobileNet");
      const results    = await classifier.classify(foodPreview);
      const key        = results[0].label.split(",")[0].toLowerCase();
      const info       = macroDB[key] || {
        protein:5, carbs:20, fats:5, energy:120,
        analysis: `Makro untuk "${key}" tidak tersedia.`
      };

      // Pie chart
      const total = info.protein + info.carbs + info.fats;
      const pct   = [
        Math.round(info.protein/total*100),
        Math.round(info.carbs/total*100),
        Math.round(info.fats/total*100)
      ];
      renderPie(pct, ["Protein","Karbo","Lemak"], macroPie);

      // Bar diff vs [15,55,30]
      const rec = [15,55,30];
      const diff = pct.map((v,i) => v - rec[i]);
      renderBar(diff, ["Protein","Karbo","Lemak"], macroDiff);

      photoAnalysis.innerHTML = `<h3>Analisis</h3><p>${info.analysis}</p>`;

      // Gemini AI overview
      geminiOverview.innerHTML = `<p style="font-style:italic;">Membuat overview AI…</p>`;
      try {
        const prompt = `Foto terdeteksi sebagai "${key}". Ringkas makronutrien dan beri rekomendasi pola makan.`;
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents:[{ parts:[{ text: prompt }] }] })
          }
        );
        const json = await res.json();
        const txt  = json.candidates?.[0]?.content?.parts?.[0]?.text || "AI gagal.";
        geminiOverview.innerHTML = `<h3>Overview AI</h3><p>${txt.replace(/\n/g, "<br>")}</p>`;
      } catch {
        geminiOverview.innerHTML = `<p style="color:red;">AI overview gagal.</p>`;
      }
    });

    function clearChart(canvas) {
      if (canvas._chart) canvas._chart.destroy();
    }
    function renderPie(data, labels, canvas) {
      clearChart(canvas);
      canvas._chart = new Chart(canvas.getContext("2d"), {
        type: "pie",
        data: { labels, datasets:[{ data, backgroundColor:["#35a35c","#f5bc51","#e57373"] }] },
        options:{ responsive:true, plugins:{ legend:{ position:"bottom" }}}
      });
    }
    function renderBar(data, labels, canvas) {
      clearChart(canvas);
      canvas._chart = new Chart(canvas.getContext("2d"), {
        type: "bar",
        data:{ labels, datasets:[{ label:"% vs Rekomendasi", data, backgroundColor:data.map(v=>v>=0?"#e57373":"#35a35c")] }],
        options:{ indexAxis:"y", responsive:true }
      });
    }
  });
  </script>
</body>
</html>
